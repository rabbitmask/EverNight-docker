import{_ as fe,a as B,r as j,k as ve,o as q,A as _e,z as he,b as ye,c as h,d as p,e as r,l as ge,f as y,w as c,F as O,h as x,n as be,g as f,m as D,p as W,j as g,t as w,v as $,x as se,E as P}from"./index-BFugLfXi.js";import{g as ke}from"./bizDict-BGApEC7U.js";const we={class:"en-page"},Se={class:"en-toolbar"},Ce={class:"en-auto-refresh"},Te={class:"en-table-wrap"},Ie={style:{display:"flex","justify-content":"flex-end",padding:"12px 0 2px"}},ze={key:0},Ae={key:1},Be={class:"en-detail-block"},Le={key:0,class:"en-section-title",style:{"margin-top":"12px"}},Ve={key:1,class:"en-detail-block"},$e=["innerHTML"],Ne={key:2,class:"en-detail-block"},Oe={class:"en-subtask-list"},He={class:"en-subtask-head"},Me={class:"en-detail-title"},Re={class:"en-subtask-body"},Ue={key:0,class:"en-subtask-meta"},Ee=["innerHTML"],De={key:1,class:"en-subtask-detail"},We={class:"en-code"},Pe={key:3,class:"en-muted",style:{"margin-top":"8px"}},Fe={__name:"ScanHistory",setup(Ke){const J=_e(),H=B([]),F=B(0),S=j({taskBizId:"",status:""}),T=j({current:1,size:20}),b=j({visible:!1,item:null}),N=B([]),M=B([]),R=B([]),G=B(),I=B(new Set),ne=ve(()=>Array.from(I.value).length),U=B(!0);let V=null;const z=async(t=!1)=>{var i,d;const e={page:T.current,size:T.size};S.taskBizId&&(e.taskCode=S.taskBizId),S.status&&(e.status=S.status);const{data:n}=await x.get("/api/scan/history",{params:e});H.value=(((i=n==null?void 0:n.data)==null?void 0:i.rows)||[]).map(m=>({...m,eventCode:(m==null?void 0:m.eventCode)||"",taskBizId:(m==null?void 0:m.taskCode)||""})),F.value=((d=n==null?void 0:n.data)==null?void 0:d.total)||0,t&&(I.value=new Set),await be(),ie()},K=async()=>{T.current=1,await z(!0)},ae=t=>{T.size=t,T.current=1,z()},le=()=>{z()},oe=t=>{const e=new Set(H.value.map(i=>i.eventCode)),n=new Set(I.value);for(const i of e)n.delete(i);for(const i of t||[])i!=null&&i.eventCode&&n.add(i.eventCode);I.value=n},ie=()=>{const t=G.value;if(t)try{t.clearSelection();for(const e of H.value)I.value.has(e.eventCode)&&t.toggleRowSelection(e,!0)}catch{}},re=t=>{b.item=t;const e=ce(t==null?void 0:t.detailJson);N.value=e.metaItems,M.value=e.subTasks,b.visible=!0},de=async t=>{var e,n;if(t!=null&&t.eventCode){try{await se.confirm(`确认删除历史 ${t.eventCode}？`,"删除确认",{type:"warning"})}catch{return}try{await x.delete(`/api/scan/history/${encodeURIComponent(t.eventCode)}`),P.success("已删除"),I.value.delete(t.eventCode),await z()}catch(i){P.error(((n=(e=i==null?void 0:i.response)==null?void 0:e.data)==null?void 0:n.message)||"删除失败")}}},ue=async()=>{var e,n;const t=Array.from(I.value);if(t.length!==0){try{await se.confirm(`确认删除选中的 ${t.length} 条历史？`,"删除确认",{type:"warning"})}catch{return}try{await x.post("/api/scan/history/batch-delete",{eventCodes:t}),P.success("已删除"),I.value=new Set,await z()}catch(i){P.error(((n=(e=i==null?void 0:i.response)==null?void 0:e.data)==null?void 0:n.message)||"删除失败")}}},Q=t=>{const e=R.value.find(n=>n.itemCode===t);return(e==null?void 0:e.itemName)||t||"未知"},X=t=>({任务端口数:"任务端口数",扫描范围:"扫描范围",端口列表:"端口列表",端口数:"任务端口数",新增待认领:"新增待认领",存活数量:"存活数量",拉取数量:"检索数量",拉取结果:"检索结果",评估对象:"评估资产",命中风险:"风险资产",目标IP:"目标 IP",查询语句:"查询语句"})[t]||t,ce=t=>{const e=String(t||"").trim();if(!e)return{metaItems:[],extraText:"",subTasks:[]};if(e.startsWith("{")&&e.endsWith("}"))try{const n=JSON.parse(e),i=Array.isArray(n==null?void 0:n.overview)?n.overview:[],d=Array.isArray(n==null?void 0:n.items)?n.items:[];if(d.length){const m=i.map(s=>({label:String((s==null?void 0:s.label)??(s==null?void 0:s.k)??"").trim(),value:String((s==null?void 0:s.value)??(s==null?void 0:s.v)??"").trim()})).filter(s=>s.label&&s.value),v=d.map((s,u)=>{const k=Array.isArray(s==null?void 0:s.metaItems)?s.metaItems:Array.isArray(s==null?void 0:s.meta)?s.meta:[],_=Array.isArray(s==null?void 0:s.detailLines)?s.detailLines:Array.isArray(s==null?void 0:s.details)?s.details:null,o=typeof(s==null?void 0:s.detailText)=="string"?s.detailText:Array.isArray(_)?_.join(`
`):"";return{key:`item_${u+1}`,title:String((s==null?void 0:s.title)||`明细 ${u+1}`),metaItems:k.map(a=>({label:String((a==null?void 0:a.label)??(a==null?void 0:a.k)??"").trim(),value:String((a==null?void 0:a.value)??(a==null?void 0:a.v)??"").trim()})).filter(a=>a.label&&a.value),detailText:String(o||"").trim()}}).filter(s=>s.metaItems.length||s.detailText);return{metaItems:m,extraText:"",subTasks:v}}}catch{}return me(e)},me=t=>{const e=String(t||"").trim();if(!e)return{metaItems:[],extraText:"",subTasks:[]};if(/^\[\d+\/\d+\]\s+/.test(e)){const u=Y(e);return{metaItems:[],extraText:e,subTasks:u}}const n=e.split(/\n\s*\n/),i=(n[0]||"").split(`
`).map(u=>u.trim()).filter(Boolean),d=[],m=["查询参数","入池信息","去噪信息","防火墙伪阳性","泛解析伪阳性","失败原因","存活判定"];for(const u of i){const k=m.find(o=>u.startsWith(`${o}：`)||u.startsWith(`${o}:`));if(k){let o=u.indexOf("：");o<0&&(o=u.indexOf(":")),d.push({label:k,value:u.slice(o+1).trim()});continue}const _=u.split(/[；;]/).map(o=>o.trim()).filter(Boolean);for(const o of _){let a=o.indexOf("：");if(a<0&&(a=o.indexOf(":")),a>0){const C=X(o.slice(0,a).trim());d.push({label:C,value:o.slice(a+1).trim()})}else d.push({label:"说明",value:o})}}const v=n.slice(1).join(`

`).trim(),s=Y(v);return{metaItems:d,extraText:v,subTasks:s}},Y=t=>{const e=String(t||"").replace(/\r\n/g,`
`).replace(/\r/g,`
`).trim();if(!e)return[];const n=e.split(`
`),i=[];let d=null;const m=/^\[(\d+)\/(\d+)\]\s+(.+)$/;for(const v of n){if(v.match(m)){d&&i.push(d),d={header:v.trim(),bodyLines:[]};continue}d||(d={header:"明细",bodyLines:[]}),d.bodyLines.push(v)}return d&&i.push(d),i.map((v,s)=>pe(v,s)).filter(Boolean)},pe=(t,e)=>{const n=String(((t==null?void 0:t.bodyLines)||[]).join(`
`)||"").trim();if(!n)return null;const i=n.split(`
`),d=[],m=[],v=_=>{const o=String(_||"").trim();return!o||o.includes("->")||/^https?:\/\//i.test(o)?!1:/扫描/.test(o)&&/(完成|终止|失败|超时|异常|中止|成功)/.test(o)},s=new Set(["执行结果","查询参数","入池信息","去噪信息","防火墙伪阳性","泛解析伪阳性","失败原因","存活判定"]),u=["查询参数","入池信息","去噪信息","防火墙伪阳性","泛解析伪阳性","失败原因","存活判定"],k=(_,o)=>{const a=String(_||"").trim(),C=String(o??"").trim();!a||!C||d.push({label:a,value:C})};for(let _=0;_<i.length;_++){const o=String(i[_]||""),a=o.trim();if(!a){m.push("");continue}const C=a.includes("：")||a.includes(":");if(!C&&d.length===0&&v(a)){k("执行结果",a);continue}const E=u.find(l=>a.startsWith(`${l}：`)||a.startsWith(`${l}:`));if(E){let l=a.indexOf("：");l<0&&(l=a.indexOf(":")),k(E,a.slice(l+1).trim());continue}if(C){let l=a.indexOf("：");if(l<0&&(l=a.indexOf(":")),l>0){const A=X(a.slice(0,l).trim()),L=a.slice(l+1).trim();if(A&&L&&s.has(A)){k(A,L);continue}}}m.push(o)}return{key:`item_${e+1}`,title:(t==null?void 0:t.header)||`明细 ${e+1}`,metaItems:d,detailText:m.join(`
`).trim()}},Z=(t,e)=>{const n=String(e??"").replace(/，/g," · ");return t==="去噪信息"||t==="入池信息"?n.replace(/([：:])\s*(\d+)(?=[^0-9]|$)/g,'$1<span class="en-num">$2</span>'):n};q(z),q(async()=>{try{R.value=await ke("TASK_STATUS")}catch{R.value=[{itemCode:"RUNNING",itemName:"运行中"},{itemCode:"SUCCESS",itemName:"成功"},{itemCode:"FAILED",itemName:"失败"}]}}),q(()=>{var e,n;const t=((e=J.query)==null?void 0:e.taskCode)||((n=J.query)==null?void 0:n.taskBizId);t&&(S.taskBizId=String(t),K()),U.value&&ee()});const ee=()=>{V&&window.clearInterval(V),V=window.setInterval(()=>{z()},3e4)},te=()=>{V&&window.clearInterval(V),V=null};return he(U,t=>{t?(z(),ee()):te()}),ye(()=>{te()}),(t,e)=>{const n=y("el-input"),i=y("el-option"),d=y("el-select"),m=y("el-button"),v=y("el-switch"),s=y("el-tag"),u=y("el-table-column"),k=y("el-table"),_=y("el-pagination"),o=y("el-descriptions-item"),a=y("el-descriptions"),C=y("el-card"),E=y("el-drawer");return f(),h(O,null,[p("div",we,[p("div",Se,[r(n,{modelValue:S.taskBizId,"onUpdate:modelValue":e[0]||(e[0]=l=>S.taskBizId=l),placeholder:"任务编号（来自任务页点击历史自动带入）",clearable:"",style:{width:"340px"},onKeyup:ge(K,["enter"])},null,8,["modelValue"]),r(d,{modelValue:S.status,"onUpdate:modelValue":e[1]||(e[1]=l=>S.status=l),placeholder:"状态",clearable:"",style:{width:"160px"}},{default:c(()=>[(f(!0),h(O,null,D(R.value,l=>(f(),W(i,{key:l.itemCode,label:l.itemName,value:l.itemCode},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),r(m,{onClick:K},{default:c(()=>[...e[5]||(e[5]=[g("查询",-1)])]),_:1}),r(m,{type:"danger",plain:"",disabled:ne.value===0,onClick:ue},{default:c(()=>[...e[6]||(e[6]=[g(" 批量删除 ",-1)])]),_:1},8,["disabled"]),e[9]||(e[9]=p("div",{class:"spacer"},null,-1)),p("div",Ce,[e[7]||(e[7]=p("span",{class:"en-auto-refresh-label"},"自动刷新",-1)),r(v,{modelValue:U.value,"onUpdate:modelValue":e[2]||(e[2]=l=>U.value=l)},null,8,["modelValue"]),e[8]||(e[8]=p("span",{class:"en-auto-refresh-tip"},"30s",-1))]),r(s,{size:"small",effect:"plain"},{default:c(()=>[g(w(F.value)+" 条",1)]),_:1})]),p("div",Te,[r(k,{ref_key:"historyTableRef",ref:G,data:H.value,height:"100%",border:"","row-key":"eventCode","reserve-selection":!0,onSelectionChange:oe},{default:c(()=>[r(u,{type:"selection",width:"46"}),r(u,{prop:"eventCode",label:"事件编号",width:"220","show-overflow-tooltip":""}),r(u,{prop:"taskBizId",label:"任务编号",width:"240","show-overflow-tooltip":""}),r(u,{prop:"status",label:"状态",width:"110"},{default:c(({row:l})=>[g(w(Q(l.status)),1)]),_:1}),r(u,{prop:"startedAt",label:"开始",width:"170"}),r(u,{prop:"finishedAt",label:"结束",width:"170"}),r(u,{prop:"summary",label:"摘要","min-width":"240","show-overflow-tooltip":""}),r(u,{label:"操作",width:"180",fixed:"right"},{default:c(({row:l})=>[r(m,{size:"small",onClick:A=>re(l)},{default:c(()=>[...e[10]||(e[10]=[g("详情",-1)])]),_:1},8,["onClick"]),r(m,{size:"small",type:"danger",plain:"",onClick:A=>de(l)},{default:c(()=>[...e[11]||(e[11]=[g("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])]),p("div",Ie,[r(_,{class:"en-pagination",layout:"total, sizes, prev, pager, next",total:F.value,"page-sizes":[20,50,100],"page-size":T.size,"current-page":T.current,"onUpdate:currentPage":e[3]||(e[3]=l=>T.current=l),onSizeChange:ae,onCurrentChange:le},null,8,["total","page-size","current-page"])])]),r(E,{modelValue:b.visible,"onUpdate:modelValue":e[4]||(e[4]=l=>b.visible=l),title:"扫描历史详情",size:"55vw","min-size":580,"max-size":900},{default:c(()=>[b.item?(f(),h("div",Ae,[e[13]||(e[13]=p("div",{class:"en-section-title"},"基础信息",-1)),p("div",Be,[r(a,{column:1,border:"","label-width":"120px"},{default:c(()=>[r(o,{label:"事件编号"},{default:c(()=>[g(w(b.item.eventCode),1)]),_:1}),r(o,{label:"任务编号"},{default:c(()=>[g(w(b.item.taskBizId),1)]),_:1}),r(o,{label:"状态"},{default:c(()=>[g(w(Q(b.item.status)),1)]),_:1}),r(o,{label:"开始时间"},{default:c(()=>[g(w(b.item.startedAt),1)]),_:1}),r(o,{label:"结束时间"},{default:c(()=>[g(w(b.item.finishedAt),1)]),_:1}),r(o,{label:"摘要"},{default:c(()=>[g(w(b.item.summary),1)]),_:1})]),_:1})]),N.value.length?(f(),h("div",Le,"执行详情")):$("",!0),N.value.length?(f(),h("div",Ve,[r(a,{column:1,border:"","label-width":"120px"},{default:c(()=>[(f(!0),h(O,null,D(N.value,l=>(f(),W(o,{key:l.label,label:l.label},{default:c(()=>[p("span",{class:"en-meta-line",innerHTML:Z(l.label,l.value||"-")},null,8,$e)]),_:2},1032,["label"]))),128))]),_:1})])):$("",!0),M.value.length?(f(),h("div",Ne,[p("div",Oe,[(f(!0),h(O,null,D(M.value,l=>(f(),W(C,{key:l.key,shadow:"never",class:"en-subtask-card"},{header:c(()=>[p("div",He,[p("span",Me,w(l.title),1)])]),default:c(()=>{var A;return[p("div",Re,[(A=l.metaItems)!=null&&A.length?(f(),h("div",Ue,[r(a,{column:1,border:"","label-width":"120px"},{default:c(()=>[(f(!0),h(O,null,D(l.metaItems,L=>(f(),W(o,{key:L.label,label:L.label},{default:c(()=>[p("span",{class:"en-meta-line",innerHTML:Z(L.label,L.value||"-")},null,8,Ee)]),_:2},1032,["label"]))),128))]),_:2},1024)])):$("",!0),l.detailText?(f(),h("div",De,[e[12]||(e[12]=p("div",{class:"en-detail-block-title"},"明细记录",-1)),p("pre",We,[p("code",null,w(l.detailText),1)])])):$("",!0)])]}),_:2},1024))),128))])])):$("",!0),!N.value.length&&!M.value.length?(f(),h("div",Pe," 暂无 ")):$("",!0)])):(f(),h("div",ze,"暂无"))]),_:1},8,["modelValue"])],64)}}},xe=fe(Fe,[["__scopeId","data-v-a7875a05"]]);export{xe as default};
