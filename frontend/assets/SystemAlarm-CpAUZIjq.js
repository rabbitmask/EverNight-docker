import{a as A,k as F,r as O,o as q,c,d as f,e as l,w as d,f as r,h as b,g as p,j as i,t as T,p as x,v as J,F as Q,E as u,x as h}from"./index-BEN9G-LX.js";const X={class:"en-page"},Y={class:"en-toolbar"},Z={class:"en-table-wrap"},ee={key:0,class:"en-muted"},te={key:1},le={style:{width:"100%"}},oe={class:"en-muted",style:{"font-size":"12px","margin-bottom":"6px"}},ne={key:0},ae={key:1},se={class:"en-muted",style:{"font-size":"12px","margin-top":"6px"}},de={key:0},ie={key:1},re={key:2},pe={__name:"SystemAlarm",setup(me){const v=A([]),_=A(new Set),E=F(()=>Array.from(_.value).length),t=O({visible:!1,mode:"create",loading:!1,form:{id:null,name:"",channelType:"DINGTALK",enabled:0,dingtalkWebhook:"",dingtalkSecret:"",dingtalkSecretSet:!1,updateSecret:!1,subscribedAlarmTypes:["CLAIM_PENDING","RISK_UNHANDLED","ASSET_REVIVE"],mergeWindowMinutes:60}}),y=async()=>{const{data:o}=await b.get("/api/system/alarm/configs");v.value=((o==null?void 0:o.data)||[]).map(e=>({...e,__testing:!1}))||[]},I=o=>{const e=new Set(v.value.map(s=>s.id)),n=new Set(_.value);for(const s of e)n.delete(s);for(const s of o||[])(s==null?void 0:s.id)!=null&&n.add(s.id);_.value=n},N=async o=>{var e,n;if((o==null?void 0:o.id)!=null){try{await h.confirm(`确认删除告警配置 ${o.name}？`,"删除确认",{type:"warning"})}catch{return}try{await b.delete(`/api/system/alarm/configs/${encodeURIComponent(o.id)}`),u.success("已删除"),_.value.delete(o.id),await y()}catch(s){u.error(((n=(e=s==null?void 0:s.response)==null?void 0:e.data)==null?void 0:n.message)||"删除失败")}}},W=async()=>{var e,n;const o=Array.from(_.value);if(o.length!==0){try{await h.confirm(`确认删除选中的 ${o.length} 个配置？`,"删除确认",{type:"warning"})}catch{return}try{await b.post("/api/system/alarm/configs/batch-delete",{ids:o}),u.success("已删除"),_.value=new Set,await y()}catch(s){u.error(((n=(e=s==null?void 0:s.response)==null?void 0:e.data)==null?void 0:n.message)||"删除失败")}}},U=()=>{t.mode="create",t.form={id:null,name:"",channelType:"DINGTALK",enabled:0,dingtalkWebhook:"",dingtalkSecret:"",dingtalkSecretSet:!1,updateSecret:!1,subscribedAlarmTypes:["CLAIM_PENDING","RISK_UNHANDLED","ASSET_REVIVE"],mergeWindowMinutes:60},t.visible=!0},D=o=>{t.mode="edit",t.form={id:o.id,name:o.name||"",channelType:o.channelType||"DINGTALK",enabled:o.enabled??0,dingtalkWebhook:o.dingtalkWebhook||"",dingtalkSecret:"",dingtalkSecretSet:!!o.dingtalkSecretSet,updateSecret:!1,subscribedAlarmTypes:o.subscribedAlarmTypes||[],mergeWindowMinutes:o.mergeWindowMinutes??60},t.visible=!0},M=async()=>{var o,e;t.loading=!0;try{if(!t.form.name||!t.form.name.trim()){u.error("请填写配置名称");return}const n={name:t.form.name.trim(),channelType:t.form.channelType,enabled:t.form.enabled,dingtalkWebhook:t.form.dingtalkWebhook,subscribedAlarmTypes:t.form.subscribedAlarmTypes||[],mergeWindowMinutes:t.form.mergeWindowMinutes};if(t.mode==="create"){const s=String(t.form.dingtalkSecret||"").trim();s&&(n.dingtalkSecret=s),await b.post("/api/system/alarm/configs",n),u.success("创建成功")}else{if(t.form.updateSecret){const m=String(t.form.dingtalkSecret||"").trim();n.dingtalkSecret=m}const s=encodeURIComponent(t.form.id);await b.post(`/api/system/alarm/configs/${s}`,n),u.success("保存成功")}t.visible=!1,await y()}catch(n){const s=(e=(o=n==null?void 0:n.response)==null?void 0:o.data)==null?void 0:e.message;u.error(s||"保存失败")}finally{t.loading=!1}},R=async o=>{try{await b.post(`/api/system/alarm/configs/${encodeURIComponent(o.id)}`,{enabled:o.enabled}),u.success("已更新")}catch{u.error("更新失败"),await y()}},L=o=>{const e=new Set(o||[]),n=[];return e.has("CLAIM_PENDING")&&n.push("资产待认领"),e.has("RISK_UNHANDLED")&&n.push("风险待处理"),e.has("ASSET_REVIVE")&&n.push("停用资产复活"),n.join("、")},$=async o=>{var e,n;try{const{value:s}=await h.prompt("请输入测试通知内容","测试通知",{inputValue:"EverNight 测试通知"});o.__testing=!0,await b.post(`/api/system/alarm/configs/${encodeURIComponent(o.id)}/test`,{content:s}),u.success("发送成功")}catch(s){if(s==="cancel"||s==="close")return;const m=(n=(e=s==null?void 0:s.response)==null?void 0:e.data)==null?void 0:n.message;u.error(m||"发送失败")}finally{o.__testing=!1}};return q(y),(o,e)=>{const n=r("el-button"),s=r("el-alert"),m=r("el-table-column"),w=r("el-switch"),C=r("el-tag"),G=r("el-table"),V=r("el-input"),g=r("el-form-item"),K=r("el-option"),z=r("el-select"),S=r("el-checkbox"),B=r("el-checkbox-group"),H=r("el-input-number"),P=r("el-form"),j=r("el-dialog");return p(),c("div",X,[f("div",Y,[l(n,{onClick:y},{default:d(()=>[...e[10]||(e[10]=[i("刷新",-1)])]),_:1}),l(n,{type:"danger",plain:"",disabled:E.value===0,onClick:W},{default:d(()=>[...e[11]||(e[11]=[i("批量删除",-1)])]),_:1},8,["disabled"]),e[13]||(e[13]=f("div",{class:"spacer"},null,-1)),l(n,{type:"primary",onClick:U},{default:d(()=>[...e[12]||(e[12]=[i("新增配置",-1)])]),_:1})]),l(s,{type:"info","show-icon":"",closable:!1,style:{"margin-bottom":"12px"}},{default:d(()=>[...e[14]||(e[14]=[i(" 支持多条告警配置：每条配置可独立启用、设置合并窗口，并按告警类型订阅（资产待认领/风险待处理/停用资产复活）。 ",-1),f("br",null,null,-1),i(" “钉钉密钥(Secret)”仅用于钉钉机器人“加签”逻辑：后端会用 Secret 生成签名参数拼接到 Webhook；出于安全考虑，密钥不会回显，只会显示“已设置/未设置”。 ",-1)])]),_:1}),f("div",Z,[l(G,{data:v.value,height:"100%",border:"","row-key":"id","reserve-selection":!0,onSelectionChange:I},{default:d(()=>[l(m,{type:"selection",width:"46"}),l(m,{prop:"name",label:"配置名称","min-width":"180","show-overflow-tooltip":""}),l(m,{prop:"channelType",label:"渠道",width:"110"}),l(m,{prop:"enabled",label:"启用",width:"90"},{default:d(({row:a})=>[l(w,{modelValue:a.enabled,"onUpdate:modelValue":k=>a.enabled=k,"active-value":1,"inactive-value":0,onChange:k=>R(a)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),l(m,{label:"订阅类型","min-width":"220"},{default:d(({row:a})=>[(a.subscribedAlarmTypes||[]).length===0?(p(),c("span",ee,"未订阅")):(p(),c("span",te,T(L(a.subscribedAlarmTypes)),1))]),_:1}),l(m,{prop:"dingtalkWebhook",label:"Webhook","min-width":"240","show-overflow-tooltip":""}),l(m,{label:"密钥",width:"100"},{default:d(({row:a})=>[a.dingtalkSecretSet?(p(),x(C,{key:0,type:"success"},{default:d(()=>[...e[15]||(e[15]=[i("已设置",-1)])]),_:1})):(p(),x(C,{key:1,type:"info"},{default:d(()=>[...e[16]||(e[16]=[i("未设置",-1)])]),_:1}))]),_:1}),l(m,{prop:"mergeWindowMinutes",label:"合并窗口",width:"120"},{default:d(({row:a})=>[i(T(a.mergeWindowMinutes??60)+" 分钟",1)]),_:1}),l(m,{prop:"updatedAt",label:"更新时间",width:"170"}),l(m,{label:"操作",width:"240",fixed:"right"},{default:d(({row:a})=>[l(n,{size:"small",onClick:k=>D(a)},{default:d(()=>[...e[17]||(e[17]=[i("编辑",-1)])]),_:1},8,["onClick"]),l(n,{size:"small",loading:a.__testing,onClick:k=>$(a)},{default:d(()=>[...e[18]||(e[18]=[i("测试",-1)])]),_:1},8,["loading","onClick"]),l(n,{size:"small",type:"danger",plain:"",onClick:k=>N(a)},{default:d(()=>[...e[19]||(e[19]=[i("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])]),l(j,{modelValue:t.visible,"onUpdate:modelValue":e[9]||(e[9]=a=>t.visible=a),title:t.mode==="create"?"新增告警配置":"编辑告警配置",width:"720px"},{footer:d(()=>[l(n,{onClick:e[8]||(e[8]=a=>t.visible=!1)},{default:d(()=>[...e[26]||(e[26]=[i("取消",-1)])]),_:1}),l(n,{type:"primary",loading:t.loading,onClick:M},{default:d(()=>[...e[27]||(e[27]=[i("保存",-1)])]),_:1},8,["loading"])]),default:d(()=>[l(P,{model:t.form,"label-width":"120px"},{default:d(()=>[l(g,{label:"配置名称"},{default:d(()=>[l(V,{modelValue:t.form.name,"onUpdate:modelValue":e[0]||(e[0]=a=>t.form.name=a),placeholder:"例如：安全群-钉钉"},null,8,["modelValue"])]),_:1}),l(g,{label:"启用"},{default:d(()=>[l(w,{modelValue:t.form.enabled,"onUpdate:modelValue":e[1]||(e[1]=a=>t.form.enabled=a),"active-value":1,"inactive-value":0},null,8,["modelValue"])]),_:1}),l(g,{label:"渠道"},{default:d(()=>[l(z,{modelValue:t.form.channelType,"onUpdate:modelValue":e[2]||(e[2]=a=>t.form.channelType=a),style:{width:"220px"}},{default:d(()=>[l(K,{label:"钉钉",value:"DINGTALK"})]),_:1},8,["modelValue"])]),_:1}),l(g,{label:"订阅类型"},{default:d(()=>[l(B,{modelValue:t.form.subscribedAlarmTypes,"onUpdate:modelValue":e[3]||(e[3]=a=>t.form.subscribedAlarmTypes=a)},{default:d(()=>[l(S,{label:"CLAIM_PENDING"},{default:d(()=>[...e[20]||(e[20]=[i("资产待认领",-1)])]),_:1}),l(S,{label:"RISK_UNHANDLED"},{default:d(()=>[...e[21]||(e[21]=[i("风险待处理",-1)])]),_:1}),l(S,{label:"ASSET_REVIVE"},{default:d(()=>[...e[22]||(e[22]=[i("停用资产复活",-1)])]),_:1})]),_:1},8,["modelValue"]),e[23]||(e[23]=f("div",{class:"en-muted",style:{"font-size":"12px","margin-top":"6px"}},"仅会向订阅了对应类型的配置发送通知。",-1))]),_:1}),l(g,{label:"钉钉 Webhook"},{default:d(()=>[l(V,{modelValue:t.form.dingtalkWebhook,"onUpdate:modelValue":e[4]||(e[4]=a=>t.form.dingtalkWebhook=a),placeholder:"https://oapi.dingtalk.com/robot/send?access_token=..."},null,8,["modelValue"])]),_:1}),l(g,{label:"钉钉密钥(Secret)"},{default:d(()=>[f("div",le,[t.mode==="edit"?(p(),c(Q,{key:0},[l(S,{modelValue:t.form.updateSecret,"onUpdate:modelValue":e[5]||(e[5]=a=>t.form.updateSecret=a),style:{"margin-bottom":"6px"}},{default:d(()=>[...e[24]||(e[24]=[i("修改/清空密钥",-1)])]),_:1},8,["modelValue"]),f("div",oe,[t.form.updateSecret?(p(),c("span",ae,"勾选后：填写则更新；留空则清空已保存密钥。")):(p(),c("span",ne,"不勾选则保持原值。"))])],64)):J("",!0),l(V,{modelValue:t.form.dingtalkSecret,"onUpdate:modelValue":e[6]||(e[6]=a=>t.form.dingtalkSecret=a),"show-password":"",disabled:t.mode==="edit"&&!t.form.updateSecret,placeholder:t.mode==="edit"&&!t.form.updateSecret?"保持原值（不回显）":"如未启用加签可留空"},null,8,["modelValue","disabled","placeholder"]),f("div",se,[t.mode==="edit"&&t.form.dingtalkSecretSet?(p(),c("span",de,"当前已保存密钥（服务端不回显）。")):t.mode==="edit"?(p(),c("span",ie,"当前未保存密钥。")):(p(),c("span",re,"如钉钉机器人开启了“加签”，请填写 Secret；未开启可留空。"))])])]),_:1}),l(g,{label:"合并窗口(分钟)"},{default:d(()=>[l(H,{modelValue:t.form.mergeWindowMinutes,"onUpdate:modelValue":e[7]||(e[7]=a=>t.form.mergeWindowMinutes=a),min:1,max:1440},null,8,["modelValue"]),e[25]||(e[25]=f("div",{class:"en-muted",style:{"font-size":"12px","margin-top":"6px"}}," 仅对“超过窗口仍未认领/未处理”的对象触发告警，避免新发现立即刷屏。 ",-1))]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}};export{pe as default};
