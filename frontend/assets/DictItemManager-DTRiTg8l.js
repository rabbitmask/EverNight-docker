import{a as h,r as C,k as W,z as X,o as Y,f as s,c as Z,g as S,d as _,e as o,l as ee,w as r,j as m,t as te,p as $,h as w,n as T,E as c,x as I}from"./index-s_Bt94In.js";const le={style:{display:"flex","flex-direction":"column","min-height":"0",gap:"12px"}},ae={class:"en-toolbar",style:{padding:"0"}},oe={class:"en-table-wrap"},ne={class:"en-footer",style:{"padding-top":"4px"}},de={__name:"DictItemManager",props:{code:{type:String,required:!0},valueLabel:{type:String,default:"值"},valuePlaceholder:{type:String,default:""},rulePlaceholder:{type:String,default:"写清楚规则含义/风险点（可选）"},searchPlaceholder:{type:String,default:"搜索 值/规则"},valueType:{type:String,default:"text"}},setup(R){const i=R,f=h([]),v=C({keyword:"",enabled:void 0}),u=C({current:1,size:20,total:0}),k=h(),g=h(new Set),A=W(()=>Array.from(g.value).length),l=C({visible:!1,loading:!1,mode:"create",id:0,form:{textValue:"",portValue:80,ruleText:"",enabled:1}}),p=async()=>{try{const{data:a}=await w.get(`/api/dict-items/${encodeURIComponent(i.code)}`,{params:{keyword:v.keyword,enabled:v.enabled,page:u.current,size:u.size}}),e=(a==null?void 0:a.data)||{};f.value=Array.isArray(e)?e:e.rows||[],u.total=Array.isArray(e)?f.value.length:Number(e.total||0);const d=new Set(f.value.map(t=>t.id));g.value=new Set(Array.from(g.value).filter(t=>d.has(t))),await T(),U()}catch{c.error("加载失败")}},P=()=>{u.current=1,p()},L=()=>{p()},B=()=>{l.mode="create",l.id=0,l.form={textValue:"",portValue:80,ruleText:"",enabled:1},l.visible=!0},E=a=>{l.mode="edit",l.id=a.id,l.form={textValue:String(a.value||""),portValue:parseInt(a.value||"80",10)||80,ruleText:a.ruleText||"",enabled:a.enabled??1},l.visible=!0},M=async()=>{var e,d;const a=i.valueType==="port"?String(l.form.portValue||""):String(l.form.textValue||"").trim();if(!a){c.error(`${i.valueLabel}不能为空`);return}l.loading=!0;try{const t={value:a,ruleText:l.form.ruleText||"",enabled:l.form.enabled};l.mode==="create"?await w.post(`/api/dict-items/${encodeURIComponent(i.code)}`,t):await w.put(`/api/dict-items/${encodeURIComponent(i.code)}/${encodeURIComponent(l.id)}`,t),c.success("已保存"),l.visible=!1,await p()}catch(t){c.error(((d=(e=t==null?void 0:t.response)==null?void 0:e.data)==null?void 0:d.message)||"保存失败")}finally{l.loading=!1}},N=async a=>{var e,d;if(a!=null&&a.id){try{const t=i.valueLabel||"数据";await I.confirm(`确认删除该${t}？此操作不可恢复。`,"删除确认",{type:"warning"})}catch{return}try{await w.delete(`/api/dict-items/${encodeURIComponent(i.code)}/${encodeURIComponent(a.id)}`),c.success("已删除"),await p()}catch(t){c.error(((d=(e=t==null?void 0:t.response)==null?void 0:e.data)==null?void 0:d.message)||"删除失败")}}},D=async()=>{var e,d;const a=Array.from(g.value);if(a.length!==0){try{const t=i.valueLabel||"数据";await I.confirm(`确认删除选中的 ${a.length} 条${t}？此操作不可恢复。`,"删除确认",{type:"warning"})}catch{return}try{await w.post(`/api/dict-items/${encodeURIComponent(i.code)}/batch-delete`,{ids:a}),c.success("已删除"),g.value=new Set,u.current=1,await p()}catch(t){c.error(((d=(e=t==null?void 0:t.response)==null?void 0:e.data)==null?void 0:d.message)||"删除失败")}}},K=a=>{const e=new Set(f.value.map(t=>t.id)),d=new Set(g.value);for(const t of e)d.delete(t);for(const t of a||[])(t==null?void 0:t.id)!=null&&d.add(t.id);g.value=d},U=()=>{const a=k.value;if(a)try{a.clearSelection();for(const e of f.value)g.value.has(e.id)&&a.toggleRowSelection(e,!0)}catch{}},j=async a=>{try{await w.post(`/api/dict-items/${encodeURIComponent(i.code)}/${encodeURIComponent(a.id)}/enabled`,{enabled:a.enabled}),c.success("已更新")}catch{c.error("更新失败"),await p()}};return X(()=>[u.current,u.size,f.value.length],async()=>{await T(),U()}),Y(p),(a,e)=>{const d=s("el-input"),t=s("el-option"),q=s("el-select"),b=s("el-button"),F=s("el-tag"),y=s("el-table-column"),z=s("el-switch"),G=s("el-table"),H=s("el-pagination"),J=s("el-input-number"),x=s("el-form-item"),O=s("el-form"),Q=s("el-dialog");return S(),Z("div",le,[_("div",ae,[o(d,{modelValue:v.keyword,"onUpdate:modelValue":e[0]||(e[0]=n=>v.keyword=n),placeholder:i.searchPlaceholder,clearable:"",style:{width:"260px"},onKeyup:ee(p,["enter"])},null,8,["modelValue","placeholder"]),o(q,{modelValue:v.enabled,"onUpdate:modelValue":e[1]||(e[1]=n=>v.enabled=n),placeholder:"启用状态",clearable:"",style:{width:"160px"}},{default:r(()=>[o(t,{label:"启用",value:1}),o(t,{label:"停用",value:0})]),_:1},8,["modelValue"]),o(b,{onClick:p},{default:r(()=>[...e[10]||(e[10]=[m("查询",-1)])]),_:1}),o(b,{type:"danger",plain:"",disabled:A.value===0,onClick:D},{default:r(()=>[...e[11]||(e[11]=[m("批量删除",-1)])]),_:1},8,["disabled"]),e[14]||(e[14]=_("div",{class:"spacer"},null,-1)),o(F,{size:"small",effect:"plain"},{default:r(()=>[m(te(f.value.length)+" 条",1)]),_:1}),o(b,{onClick:p},{default:r(()=>[...e[12]||(e[12]=[m("刷新",-1)])]),_:1}),o(b,{type:"primary",onClick:B},{default:r(()=>[...e[13]||(e[13]=[m("新增",-1)])]),_:1})]),_("div",oe,[o(G,{ref_key:"tableRef",ref:k,data:f.value,height:"100%",border:"","row-key":"id","reserve-selection":!0,onSelectionChange:K},{default:r(()=>[o(y,{type:"selection",width:"46"}),o(y,{prop:"value",label:i.valueLabel,"min-width":"180","show-overflow-tooltip":""},null,8,["label"]),o(y,{prop:"ruleText",label:"规则","min-width":"260","show-overflow-tooltip":""}),o(y,{prop:"enabled",label:"启用",width:"90"},{default:r(({row:n})=>[o(z,{modelValue:n.enabled,"onUpdate:modelValue":V=>n.enabled=V,"active-value":1,"inactive-value":0,onChange:V=>j(n)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),o(y,{prop:"updatedAt",label:"更新时间",width:"170"}),o(y,{label:"操作",width:"200",fixed:"right"},{default:r(({row:n})=>[o(b,{size:"small",onClick:V=>E(n)},{default:r(()=>[...e[15]||(e[15]=[m("编辑",-1)])]),_:1},8,["onClick"]),o(b,{size:"small",type:"danger",plain:"",onClick:V=>N(n)},{default:r(()=>[...e[16]||(e[16]=[m("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])]),_("div",ne,[o(H,{class:"en-pagination",layout:"total, sizes, prev, pager, next",total:u.total,"page-size":u.size,"page-sizes":[20,50,100],"current-page":u.current,"onUpdate:currentPage":e[2]||(e[2]=n=>u.current=n),"onUpdate:pageSize":e[3]||(e[3]=n=>u.size=n),onSizeChange:P,onCurrentChange:L},null,8,["total","page-size","current-page"])]),o(Q,{modelValue:l.visible,"onUpdate:modelValue":e[9]||(e[9]=n=>l.visible=n),title:l.mode==="create"?"新增":"编辑",width:"600px"},{footer:r(()=>[o(b,{disabled:l.loading,onClick:e[8]||(e[8]=n=>l.visible=!1)},{default:r(()=>[...e[17]||(e[17]=[m("取消",-1)])]),_:1},8,["disabled"]),o(b,{type:"primary",loading:l.loading,onClick:M},{default:r(()=>[...e[18]||(e[18]=[m("保存",-1)])]),_:1},8,["loading"])]),default:r(()=>[o(O,{model:l.form,"label-width":"92px"},{default:r(()=>[o(x,{label:i.valueLabel},{default:r(()=>[i.valueType==="port"?(S(),$(J,{key:0,modelValue:l.form.portValue,"onUpdate:modelValue":e[4]||(e[4]=n=>l.form.portValue=n),min:1,max:65535,"controls-position":"right",style:{width:"100%"}},null,8,["modelValue"])):(S(),$(d,{key:1,modelValue:l.form.textValue,"onUpdate:modelValue":e[5]||(e[5]=n=>l.form.textValue=n),placeholder:i.valuePlaceholder},null,8,["modelValue","placeholder"]))]),_:1},8,["label"]),o(x,{label:"规则"},{default:r(()=>[o(d,{modelValue:l.form.ruleText,"onUpdate:modelValue":e[6]||(e[6]=n=>l.form.ruleText=n),placeholder:i.rulePlaceholder},null,8,["modelValue","placeholder"])]),_:1}),o(x,{label:"启用"},{default:r(()=>[o(z,{modelValue:l.form.enabled,"onUpdate:modelValue":e[7]||(e[7]=n=>l.form.enabled=n),"active-value":1,"inactive-value":0},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}};export{de as _};
