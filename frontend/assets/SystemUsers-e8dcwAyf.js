import{a as k,r as S,k as $,o as P,c as j,d as y,e as t,l as D,f as d,w as r,F as O,h as w,g as G,j as m,t as H,E as i,x as h,n as J}from"./index-s_Bt94In.js";const Q={class:"en-page"},W={class:"en-toolbar"},X={class:"en-table-wrap"},ee={__name:"SystemUsers",setup(Y){const U=k([]),u=S({keyword:"",enabled:void 0}),c=k(new Set),R=$(()=>Array.from(c.value).length),_=k(),I={username:[{required:!0,message:"用户名不能为空",trigger:"blur"}],password:[{required:!0,message:"密码不能为空",trigger:"blur"}]},s=S({visible:!1,loading:!1,form:{username:"",password:"",enabled:1}}),p=async()=>{const{data:l}=await w.get("/api/system/users");U.value=(l==null?void 0:l.data)||[],c.value=new Set},V=$(()=>{const l=String(u.keyword||"").trim().toLowerCase();return U.value.filter(e=>(u.enabled===0||u.enabled===1)&&Number(e.enabled??0)!==Number(u.enabled)?!1:l?String(e.username||"").toLowerCase().includes(l):!0)}),N=async l=>{try{await w.post(`/api/system/users/${encodeURIComponent(l.id)}/enabled`,{enabled:l.enabled}),i.success("已更新")}catch{i.error("更新失败"),await p()}},q=()=>{s.form={username:"",password:"",enabled:1},s.visible=!0,J(()=>{var l,e;return(e=(l=_.value)==null?void 0:l.clearValidate)==null?void 0:e.call(l)})},A=async()=>{var l,e,n,a;s.loading=!0;try{await((e=(l=_.value)==null?void 0:l.validate)==null?void 0:e.call(l)),await w.post("/api/system/users",s.form),i.success("创建成功"),s.visible=!1,await p()}catch(g){i.error(((a=(n=g==null?void 0:g.response)==null?void 0:n.data)==null?void 0:a.message)||"创建失败")}finally{s.loading=!1}},B=async l=>{const{value:e}=await h.prompt("请输入新密码","重置密码",{inputType:"password"});try{await w.post(`/api/system/users/${encodeURIComponent(l.id)}/reset-password`,{newPassword:e}),i.success("已重置"),await p()}catch{i.error("重置失败")}},E=l=>{const e=new Set(V.value.map(a=>a.id)),n=new Set(c.value);for(const a of e)n.delete(a);for(const a of l||[])(a==null?void 0:a.id)!=null&&n.add(a.id);c.value=n},z=async l=>{var e,n;if((l==null?void 0:l.id)!=null){try{await h.confirm(`确认删除用户 ${l.username}？`,"删除确认",{type:"warning"})}catch{return}try{await w.delete(`/api/system/users/${encodeURIComponent(l.id)}`),i.success("已删除"),c.value.delete(l.id),await p()}catch(a){i.error(((n=(e=a==null?void 0:a.response)==null?void 0:e.data)==null?void 0:n.message)||"删除失败")}}},M=async()=>{var e,n;const l=Array.from(c.value);if(l.length!==0){try{await h.confirm(`确认删除选中的 ${l.length} 个用户？`,"删除确认",{type:"warning"})}catch{return}try{await w.post("/api/system/users/batch-delete",{ids:l}),i.success("已删除"),c.value=new Set,await p()}catch(a){i.error(((n=(e=a==null?void 0:a.response)==null?void 0:e.data)==null?void 0:n.message)||"删除失败")}}};return P(p),(l,e)=>{const n=d("el-input"),a=d("el-option"),g=d("el-select"),f=d("el-button"),T=d("el-tag"),b=d("el-table-column"),x=d("el-switch"),F=d("el-table"),C=d("el-form-item"),K=d("el-form"),L=d("el-dialog");return G(),j(O,null,[y("div",Q,[y("div",W,[t(n,{modelValue:u.keyword,"onUpdate:modelValue":e[0]||(e[0]=o=>u.keyword=o),placeholder:"搜索 用户名",clearable:"",style:{width:"260px"},onKeyup:D(p,["enter"])},null,8,["modelValue"]),t(g,{modelValue:u.enabled,"onUpdate:modelValue":e[1]||(e[1]=o=>u.enabled=o),placeholder:"启用状态",clearable:"",style:{width:"140px"}},{default:r(()=>[t(a,{label:"启用",value:1}),t(a,{label:"停用",value:0})]),_:1},8,["modelValue"]),t(f,{onClick:p},{default:r(()=>[...e[7]||(e[7]=[m("刷新",-1)])]),_:1}),t(f,{type:"danger",plain:"",disabled:R.value===0,onClick:M},{default:r(()=>[...e[8]||(e[8]=[m("批量删除",-1)])]),_:1},8,["disabled"]),e[10]||(e[10]=y("div",{class:"spacer"},null,-1)),t(T,{size:"small",effect:"plain"},{default:r(()=>[m(H(V.value.length)+" 条",1)]),_:1}),t(f,{type:"primary",onClick:q},{default:r(()=>[...e[9]||(e[9]=[m("新增用户",-1)])]),_:1})]),y("div",X,[t(F,{data:V.value,height:"100%",border:"","row-key":"id","reserve-selection":!0,onSelectionChange:E},{default:r(()=>[t(b,{type:"selection",width:"46"}),t(b,{prop:"username",label:"用户名","min-width":"180","show-overflow-tooltip":""}),t(b,{prop:"enabled",label:"启用",width:"90"},{default:r(({row:o})=>[t(x,{modelValue:o.enabled,"onUpdate:modelValue":v=>o.enabled=v,"active-value":1,"inactive-value":0,onChange:v=>N(o)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),t(b,{prop:"createdAt",label:"创建时间",width:"170"}),t(b,{prop:"updatedAt",label:"更新时间",width:"170"}),t(b,{label:"操作",width:"200",fixed:"right"},{default:r(({row:o})=>[t(f,{size:"small",onClick:v=>B(o)},{default:r(()=>[...e[11]||(e[11]=[m("重置密码",-1)])]),_:1},8,["onClick"]),t(f,{size:"small",type:"danger",plain:"",onClick:v=>z(o)},{default:r(()=>[...e[12]||(e[12]=[m("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])])]),t(L,{modelValue:s.visible,"onUpdate:modelValue":e[6]||(e[6]=o=>s.visible=o),title:"新增用户",width:"560px"},{footer:r(()=>[t(f,{disabled:s.loading,onClick:e[5]||(e[5]=o=>s.visible=!1)},{default:r(()=>[...e[13]||(e[13]=[m("取消",-1)])]),_:1},8,["disabled"]),t(f,{type:"primary",loading:s.loading,onClick:A},{default:r(()=>[...e[14]||(e[14]=[m("创建",-1)])]),_:1},8,["loading"])]),default:r(()=>[t(K,{ref_key:"formRef",ref:_,model:s.form,rules:I,"label-width":"92px"},{default:r(()=>[t(C,{label:"用户名",prop:"username",required:""},{default:r(()=>[t(n,{modelValue:s.form.username,"onUpdate:modelValue":e[2]||(e[2]=o=>s.form.username=o),placeholder:"用于登录，建议字母/数字/下划线"},null,8,["modelValue"])]),_:1}),t(C,{label:"初始密码",prop:"password",required:""},{default:r(()=>[t(n,{modelValue:s.form.password,"onUpdate:modelValue":e[3]||(e[3]=o=>s.form.password=o),type:"password","show-password":"",placeholder:"至少 6 位（建议 10+）"},null,8,["modelValue"])]),_:1}),t(C,{label:"启用"},{default:r(()=>[t(x,{modelValue:s.form.enabled,"onUpdate:modelValue":e[4]||(e[4]=o=>s.form.enabled=o),"active-value":1,"inactive-value":0},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])],64)}}};export{ee as default};
