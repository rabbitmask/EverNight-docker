import{_ as de,a as k,r as L,k as ue,o as M,A as ce,z as pe,b as me,c as z,d as r,e as a,l as fe,f as c,w as o,F as E,h as O,n as ve,g as _,m as W,p as G,j as p,t as b,v as D,x as Q,E as N}from"./index-BEN9G-LX.js";import{g as _e}from"./bizDict-CVILYPll.js";const ge={class:"en-page"},ye={class:"en-toolbar"},be={class:"en-auto-refresh"},he={class:"en-table-wrap"},Ce={style:{display:"flex","justify-content":"flex-end",padding:"12px 0 2px"}},we={key:0},ke={key:1},ze={class:"en-detail-block"},xe={key:0,class:"en-detail-block"},Ie=["innerHTML"],Se={key:1,class:"en-detail-block"},Be={class:"en-code"},Ve={key:2,class:"en-muted",style:{"margin-top":"8px"}},Te={__name:"AssessHistory",setup(Ae){const P=ce(),I=k([]),U=k(0),g=L({taskBizId:"",status:""}),h=L({current:1,size:20}),m=L({visible:!1,item:null}),S=k([]),B=k(""),V=k([]),j=k(),C=k(new Set),J=ue(()=>Array.from(C.value).length),T=k(!0);let x=null;const w=async(t=!1)=>{var l,y;const e={page:h.current,size:h.size};g.taskBizId&&(e.taskCode=g.taskBizId),g.status&&(e.status=g.status);const{data:s}=await O.get("/api/assess/history",{params:e});I.value=(((l=s==null?void 0:s.data)==null?void 0:l.rows)||[]).map(d=>({...d,eventCode:(d==null?void 0:d.eventCode)||"",taskBizId:(d==null?void 0:d.taskCode)||""})),U.value=((y=s==null?void 0:s.data)==null?void 0:y.total)||0,t&&(C.value=new Set),await ve(),ee()},$=async()=>{h.current=1,await w(!0)},X=t=>{h.size=t,h.current=1,w()},Y=()=>{w()},Z=t=>{const e=new Set(I.value.map(l=>l.eventCode)),s=new Set(C.value);for(const l of e)s.delete(l);for(const l of t||[])l!=null&&l.eventCode&&s.add(l.eventCode);C.value=s},ee=()=>{const t=j.value;if(t)try{t.clearSelection();for(const e of I.value)C.value.has(e.eventCode)&&t.toggleRowSelection(e,!0)}catch{}},te=t=>{m.item=t;const e=ne(t==null?void 0:t.detail);S.value=e.metaItems,B.value=e.extraText,m.visible=!0},se=async t=>{var e,s;if(t!=null&&t.eventCode){try{await Q.confirm(`确认删除历史 ${t.eventCode}？`,"删除确认",{type:"warning"})}catch{return}try{await O.delete(`/api/assess/history/${encodeURIComponent(t.eventCode)}`),N.success("已删除"),C.value.delete(t.eventCode),await w()}catch(l){N.error(((s=(e=l==null?void 0:l.response)==null?void 0:e.data)==null?void 0:s.message)||"删除失败")}}},ae=async()=>{var e,s;const t=Array.from(C.value);if(t.length!==0){try{await Q.confirm(`确认删除选中的 ${t.length} 条历史？`,"删除确认",{type:"warning"})}catch{return}try{await O.post("/api/assess/history/batch-delete",{eventCodes:t}),N.success("已删除"),C.value=new Set,await w()}catch(l){N.error(((s=(e=l==null?void 0:l.response)==null?void 0:e.data)==null?void 0:s.message)||"删除失败")}}},q=t=>{const e=V.value.find(s=>s.itemCode===t);return(e==null?void 0:e.itemName)||t||"未知"},le=t=>({任务端口数:"任务端口数",扫描范围:"扫描范围",端口列表:"端口列表",端口数:"任务端口数",新增待认领:"新增待认领",存活数量:"存活数量",拉取数量:"检索数量",拉取结果:"检索结果",评估对象:"评估资产",命中风险:"风险资产",目标IP:"目标 IP",查询语句:"查询语句"})[t]||t,ne=t=>{const e=String(t||"").trim();if(!e)return{metaItems:[],extraText:""};const s=e.split(/\n\s*\n/),l=(s[0]||"").split(`
`).map(v=>v.trim()).filter(Boolean),y=[],d=["查询参数","入池信息","去噪信息","防火墙伪阳性","泛解析伪阳性","失败原因","存活判定"];for(const v of l){const f=d.find(i=>v.startsWith(`${i}：`)||v.startsWith(`${i}:`));if(f){let i=v.indexOf("：");i<0&&(i=v.indexOf(":")),y.push({label:f,value:v.slice(i+1).trim()});continue}const H=v.split(/[；;]/).map(i=>i.trim()).filter(Boolean);for(const i of H){let u=i.indexOf("：");if(u<0&&(u=i.indexOf(":")),u>0){const A=le(i.slice(0,u).trim());y.push({label:A,value:i.slice(u+1).trim()})}else y.push({label:"说明",value:i})}}const R=s.slice(1).join(`

`).trim();return{metaItems:y,extraText:R}},oe=(t,e)=>{const s=String(e??"").replace(/，/g," · ");return t==="去噪信息"||t==="入池信息"?s.replace(/([：:])\s*(\d+)(?=[^0-9]|$)/g,'$1<span class="en-num">$2</span>'):s};M(w),M(async()=>{try{V.value=await _e("TASK_STATUS")}catch{V.value=[{itemCode:"RUNNING",itemName:"运行中"},{itemCode:"SUCCESS",itemName:"成功"},{itemCode:"FAILED",itemName:"失败"}]}}),M(()=>{var e,s;const t=((e=P.query)==null?void 0:e.taskCode)||((s=P.query)==null?void 0:s.taskBizId);t&&(g.taskBizId=String(t),$()),T.value&&F()});const F=()=>{x&&window.clearInterval(x),x=window.setInterval(()=>{w()},3e4)},K=()=>{x&&window.clearInterval(x),x=null};return pe(T,t=>{t?(w(),F()):K()}),me(()=>{K()}),(t,e)=>{const s=c("el-input"),l=c("el-option"),y=c("el-select"),d=c("el-button"),R=c("el-switch"),v=c("el-tag"),f=c("el-table-column"),H=c("el-table"),i=c("el-pagination"),u=c("el-descriptions-item"),A=c("el-descriptions"),ie=c("el-drawer");return _(),z(E,null,[r("div",ge,[r("div",ye,[a(s,{modelValue:g.taskBizId,"onUpdate:modelValue":e[0]||(e[0]=n=>g.taskBizId=n),placeholder:"任务编号（来自任务页点击历史自动带入）",clearable:"",style:{width:"340px"},onKeyup:fe($,["enter"])},null,8,["modelValue"]),a(y,{modelValue:g.status,"onUpdate:modelValue":e[1]||(e[1]=n=>g.status=n),placeholder:"状态",clearable:"",style:{width:"160px"}},{default:o(()=>[(_(!0),z(E,null,W(V.value,n=>(_(),G(l,{key:n.itemCode,label:n.itemName,value:n.itemCode},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a(d,{onClick:$},{default:o(()=>[...e[5]||(e[5]=[p("查询",-1)])]),_:1}),a(d,{type:"danger",plain:"",disabled:J.value===0,onClick:ae},{default:o(()=>[...e[6]||(e[6]=[p(" 批量删除 ",-1)])]),_:1},8,["disabled"]),e[9]||(e[9]=r("div",{class:"spacer"},null,-1)),r("div",be,[e[7]||(e[7]=r("span",{class:"en-auto-refresh-label"},"自动刷新",-1)),a(R,{modelValue:T.value,"onUpdate:modelValue":e[2]||(e[2]=n=>T.value=n)},null,8,["modelValue"]),e[8]||(e[8]=r("span",{class:"en-auto-refresh-tip"},"30s",-1))]),a(v,{size:"small",effect:"plain"},{default:o(()=>[p(b(U.value)+" 条",1)]),_:1})]),r("div",he,[a(H,{ref_key:"historyTableRef",ref:j,data:I.value,height:"100%",border:"","row-key":"eventCode","reserve-selection":!0,onSelectionChange:Z},{default:o(()=>[a(f,{type:"selection",width:"46"}),a(f,{prop:"eventCode",label:"事件编号",width:"220","show-overflow-tooltip":""}),a(f,{prop:"taskBizId",label:"任务编号",width:"240","show-overflow-tooltip":""}),a(f,{prop:"status",label:"状态",width:"110"},{default:o(({row:n})=>[p(b(q(n.status)),1)]),_:1}),a(f,{prop:"startedAt",label:"开始",width:"170"}),a(f,{prop:"finishedAt",label:"结束",width:"170"}),a(f,{prop:"summary",label:"摘要","min-width":"240","show-overflow-tooltip":""}),a(f,{label:"操作",width:"180",fixed:"right"},{default:o(({row:n})=>[a(d,{size:"small",onClick:re=>te(n)},{default:o(()=>[...e[10]||(e[10]=[p("详情",-1)])]),_:1},8,["onClick"]),a(d,{size:"small",type:"danger",plain:"",onClick:re=>se(n)},{default:o(()=>[...e[11]||(e[11]=[p("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])]),r("div",Ce,[a(i,{class:"en-pagination",layout:"total, sizes, prev, pager, next",total:U.value,"page-sizes":[20,50,100],"page-size":h.size,"current-page":h.current,"onUpdate:currentPage":e[3]||(e[3]=n=>h.current=n),onSizeChange:X,onCurrentChange:Y},null,8,["total","page-size","current-page"])])]),a(ie,{modelValue:m.visible,"onUpdate:modelValue":e[4]||(e[4]=n=>m.visible=n),title:"评估历史详情",size:"55vw","min-size":580,"max-size":900},{default:o(()=>[m.item?(_(),z("div",ke,[e[13]||(e[13]=r("div",{class:"en-section-title"},"基础信息",-1)),r("div",ze,[a(A,{column:1,border:"","label-width":"120px"},{default:o(()=>[a(u,{label:"事件编号"},{default:o(()=>[p(b(m.item.eventCode),1)]),_:1}),a(u,{label:"任务编号"},{default:o(()=>[p(b(m.item.taskBizId),1)]),_:1}),a(u,{label:"状态"},{default:o(()=>[p(b(q(m.item.status)),1)]),_:1}),a(u,{label:"开始时间"},{default:o(()=>[p(b(m.item.startedAt),1)]),_:1}),a(u,{label:"结束时间"},{default:o(()=>[p(b(m.item.finishedAt),1)]),_:1}),a(u,{label:"摘要"},{default:o(()=>[p(b(m.item.summary),1)]),_:1})]),_:1})]),e[14]||(e[14]=r("div",{class:"en-section-title",style:{"margin-top":"12px"}},"执行详情",-1)),S.value.length?(_(),z("div",xe,[a(A,{column:1,border:"","label-width":"120px"},{default:o(()=>[(_(!0),z(E,null,W(S.value,n=>(_(),G(u,{key:n.label,label:n.label},{default:o(()=>[r("span",{class:"en-meta-line",innerHTML:oe(n.label,n.value||"-")},null,8,Ie)]),_:2},1032,["label"]))),128))]),_:1})])):D("",!0),B.value?(_(),z("div",Se,[e[12]||(e[12]=r("div",{class:"en-detail-block-title"},"明细记录",-1)),r("pre",Be,[r("code",null,b(B.value),1)])])):D("",!0),!S.value.length&&!B.value?(_(),z("div",Ve,"暂无")):D("",!0)])):(_(),z("div",we,"暂无"))]),_:1},8,["modelValue"])],64)}}},$e=de(Te,[["__scopeId","data-v-45c23fe1"]]);export{$e as default};
