import{_ as me,a as T,r as W,k as fe,o as q,A as ve,z as _e,b as he,c as v,d as c,e as o,l as be,f as _,w as r,F as N,h as F,n as ge,g as p,m as E,p as j,j as b,t as k,v as $,x as se,E as D}from"./index-Qb-yzKSP.js";import{g as ye}from"./bizDict-BbfxjU8h.js";const ke={class:"en-page"},we={class:"en-toolbar"},Ce={class:"en-auto-refresh"},Se={class:"en-table-wrap"},xe={style:{display:"flex","justify-content":"flex-end",padding:"12px 0 2px"}},ze={key:0},Ie={key:1},Te={class:"en-detail-block"},Be={key:0,class:"en-section-title",style:{"margin-top":"12px"}},Ve={key:1,class:"en-detail-block"},Le=["innerHTML"],$e={key:2,class:"en-detail-block"},Ae={class:"en-subtask-list"},Ne={class:"en-subtask-head"},He={class:"en-detail-title"},Me={class:"en-subtask-body"},Oe={key:0,class:"en-subtask-meta"},Re=["innerHTML"],Ue={key:1,class:"en-subtask-detail"},Ee={class:"en-code"},je={key:3,class:"en-muted",style:{"margin-top":"8px"}},De={__name:"ScanHistory",setup(Pe){const G=ve(),H=T([]),P=T(0),w=W({taskBizId:"",status:""}),C=W({current:1,size:20}),g=W({visible:!1,item:null}),A=T([]),M=T([]),O=T([]),Q=T(),S=T(new Set),ne=fe(()=>Array.from(S.value).length),R=T(!0);let V=null;const x=async(t=!1)=>{var l,d;const e={page:C.current,size:C.size};w.taskBizId&&(e.taskCode=w.taskBizId),w.status&&(e.status=w.status);const{data:n}=await F.get("/api/scan/history",{params:e});H.value=(((l=n==null?void 0:n.data)==null?void 0:l.rows)||[]).map(u=>({...u,eventCode:(u==null?void 0:u.eventCode)||"",taskBizId:(u==null?void 0:u.taskCode)||""})),P.value=((d=n==null?void 0:n.data)==null?void 0:d.total)||0,t&&(S.value=new Set),await ge(),ie()},K=async()=>{C.current=1,await x(!0)},ae=t=>{C.size=t,C.current=1,x()},le=()=>{x()},oe=t=>{const e=new Set(H.value.map(l=>l.eventCode)),n=new Set(S.value);for(const l of e)n.delete(l);for(const l of t||[])l!=null&&l.eventCode&&n.add(l.eventCode);S.value=n},ie=()=>{const t=Q.value;if(t)try{t.clearSelection();for(const e of H.value)S.value.has(e.eventCode)&&t.toggleRowSelection(e,!0)}catch{}},re=t=>{g.item=t;const e=ce(t==null?void 0:t.detail);A.value=e.metaItems,M.value=e.subTasks,g.visible=!0},de=async t=>{var e,n;if(t!=null&&t.eventCode){try{await se.confirm(`确认删除历史 ${t.eventCode}？`,"删除确认",{type:"warning"})}catch{return}try{await F.delete(`/api/scan/history/${encodeURIComponent(t.eventCode)}`),D.success("已删除"),S.value.delete(t.eventCode),await x()}catch(l){D.error(((n=(e=l==null?void 0:l.response)==null?void 0:e.data)==null?void 0:n.message)||"删除失败")}}},ue=async()=>{var e,n;const t=Array.from(S.value);if(t.length!==0){try{await se.confirm(`确认删除选中的 ${t.length} 条历史？`,"删除确认",{type:"warning"})}catch{return}try{await F.post("/api/scan/history/batch-delete",{eventCodes:t}),D.success("已删除"),S.value=new Set,await x()}catch(l){D.error(((n=(e=l==null?void 0:l.response)==null?void 0:e.data)==null?void 0:n.message)||"删除失败")}}},J=t=>{const e=O.value.find(n=>n.itemCode===t);return(e==null?void 0:e.itemName)||t||"未知"},X=t=>({任务端口数:"任务端口数",扫描范围:"扫描范围",端口列表:"端口列表",端口数:"任务端口数",新增待认领:"新增待认领",存活数量:"存活数量",拉取数量:"检索数量",拉取结果:"检索结果",评估对象:"评估资产",命中风险:"风险资产",目标IP:"目标 IP",查询语句:"查询语句"})[t]||t,ce=t=>{const e=String(t||"").trim();if(!e)return{metaItems:[],extraText:"",subTasks:[]};if(/^\[\d+\/\d+\]\s+/.test(e)){const i=Y(e);return{metaItems:[],extraText:e,subTasks:i}}const n=e.split(/\n\s*\n/),l=(n[0]||"").split(`
`).map(i=>i.trim()).filter(Boolean),d=[],u=["查询参数","入池信息","去噪信息","防火墙伪阳性","泛解析伪阳性","失败原因","存活判定"];for(const i of l){const y=u.find(s=>i.startsWith(`${s}：`)||i.startsWith(`${s}:`));if(y){let s=i.indexOf("：");s<0&&(s=i.indexOf(":")),d.push({label:y,value:i.slice(s+1).trim()});continue}const I=i.split(/[；;]/).map(s=>s.trim()).filter(Boolean);for(const s of I){let m=s.indexOf("：");if(m<0&&(m=s.indexOf(":")),m>0){const L=X(s.slice(0,m).trim());d.push({label:L,value:s.slice(m+1).trim()})}else d.push({label:"说明",value:s})}}const h=n.slice(1).join(`

`).trim(),z=Y(h);return{metaItems:d,extraText:h,subTasks:z}},Y=t=>{const e=String(t||"").replace(/\r\n/g,`
`).replace(/\r/g,`
`).trim();if(!e)return[];const n=e.split(`
`),l=[];let d=null;const u=/^\[(\d+)\/(\d+)\]\s+(.+)$/;for(const h of n){if(h.match(u)){d&&l.push(d),d={header:h.trim(),bodyLines:[]};continue}d||(d={header:"明细",bodyLines:[]}),d.bodyLines.push(h)}return d&&l.push(d),l.map((h,z)=>pe(h,z)).filter(Boolean)},pe=(t,e)=>{const n=String(((t==null?void 0:t.bodyLines)||[]).join(`
`)||"").trim();if(!n)return null;const l=n.split(`
`),d=[],u=[],h=new Set(["执行结果","查询参数","入池信息","去噪信息","防火墙伪阳性","泛解析伪阳性","失败原因","存活判定"]),z=["查询参数","入池信息","去噪信息","防火墙伪阳性","泛解析伪阳性","失败原因","存活判定"],i=(y,I)=>{const s=String(y||"").trim(),m=String(I??"").trim();!s||!m||d.push({label:s,value:m})};for(let y=0;y<l.length;y++){const I=String(l[y]||""),s=I.trim();if(!s){u.push("");continue}const m=s.includes("：")||s.includes(":");if(!m&&d.length===0){i("执行结果",s);continue}const L=z.find(f=>s.startsWith(`${f}：`)||s.startsWith(`${f}:`));if(L){let f=s.indexOf("：");f<0&&(f=s.indexOf(":")),i(L,s.slice(f+1).trim());continue}if(m){let f=s.indexOf("：");if(f<0&&(f=s.indexOf(":")),f>0){const a=X(s.slice(0,f).trim()),B=s.slice(f+1).trim();if(a&&B&&h.has(a)){i(a,B);continue}}}u.push(I)}return{key:`item_${e+1}`,title:(t==null?void 0:t.header)||`明细 ${e+1}`,metaItems:d,detailText:u.join(`
`).trim()}},Z=(t,e)=>{const n=String(e??"").replace(/，/g," · ");return t==="去噪信息"||t==="入池信息"?n.replace(/([：:])\s*(\d+)(?=[^0-9]|$)/g,'$1<span class="en-num">$2</span>'):n};q(x),q(async()=>{try{O.value=await ye("TASK_STATUS")}catch{O.value=[{itemCode:"RUNNING",itemName:"运行中"},{itemCode:"SUCCESS",itemName:"成功"},{itemCode:"FAILED",itemName:"失败"}]}}),q(()=>{var e,n;const t=((e=G.query)==null?void 0:e.taskCode)||((n=G.query)==null?void 0:n.taskBizId);t&&(w.taskBizId=String(t),K()),R.value&&ee()});const ee=()=>{V&&window.clearInterval(V),V=window.setInterval(()=>{x()},3e4)},te=()=>{V&&window.clearInterval(V),V=null};return _e(R,t=>{t?(x(),ee()):te()}),he(()=>{te()}),(t,e)=>{const n=_("el-input"),l=_("el-option"),d=_("el-select"),u=_("el-button"),h=_("el-switch"),z=_("el-tag"),i=_("el-table-column"),y=_("el-table"),I=_("el-pagination"),s=_("el-descriptions-item"),m=_("el-descriptions"),L=_("el-card"),f=_("el-drawer");return p(),v(N,null,[c("div",ke,[c("div",we,[o(n,{modelValue:w.taskBizId,"onUpdate:modelValue":e[0]||(e[0]=a=>w.taskBizId=a),placeholder:"任务编号（来自任务页点击历史自动带入）",clearable:"",style:{width:"340px"},onKeyup:be(K,["enter"])},null,8,["modelValue"]),o(d,{modelValue:w.status,"onUpdate:modelValue":e[1]||(e[1]=a=>w.status=a),placeholder:"状态",clearable:"",style:{width:"160px"}},{default:r(()=>[(p(!0),v(N,null,E(O.value,a=>(p(),j(l,{key:a.itemCode,label:a.itemName,value:a.itemCode},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),o(u,{onClick:K},{default:r(()=>[...e[5]||(e[5]=[b("查询",-1)])]),_:1}),o(u,{type:"danger",plain:"",disabled:ne.value===0,onClick:ue},{default:r(()=>[...e[6]||(e[6]=[b(" 批量删除 ",-1)])]),_:1},8,["disabled"]),e[9]||(e[9]=c("div",{class:"spacer"},null,-1)),c("div",Ce,[e[7]||(e[7]=c("span",{class:"en-auto-refresh-label"},"自动刷新",-1)),o(h,{modelValue:R.value,"onUpdate:modelValue":e[2]||(e[2]=a=>R.value=a)},null,8,["modelValue"]),e[8]||(e[8]=c("span",{class:"en-auto-refresh-tip"},"30s",-1))]),o(z,{size:"small",effect:"plain"},{default:r(()=>[b(k(P.value)+" 条",1)]),_:1})]),c("div",Se,[o(y,{ref_key:"historyTableRef",ref:Q,data:H.value,height:"100%",border:"","row-key":"eventCode","reserve-selection":!0,onSelectionChange:oe},{default:r(()=>[o(i,{type:"selection",width:"46"}),o(i,{prop:"eventCode",label:"事件编号",width:"220","show-overflow-tooltip":""}),o(i,{prop:"taskBizId",label:"任务编号",width:"240","show-overflow-tooltip":""}),o(i,{prop:"status",label:"状态",width:"110"},{default:r(({row:a})=>[b(k(J(a.status)),1)]),_:1}),o(i,{prop:"startedAt",label:"开始",width:"170"}),o(i,{prop:"finishedAt",label:"结束",width:"170"}),o(i,{prop:"summary",label:"摘要","min-width":"240","show-overflow-tooltip":""}),o(i,{label:"操作",width:"180",fixed:"right"},{default:r(({row:a})=>[o(u,{size:"small",onClick:B=>re(a)},{default:r(()=>[...e[10]||(e[10]=[b("详情",-1)])]),_:1},8,["onClick"]),o(u,{size:"small",type:"danger",plain:"",onClick:B=>de(a)},{default:r(()=>[...e[11]||(e[11]=[b("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])]),c("div",xe,[o(I,{class:"en-pagination",layout:"total, sizes, prev, pager, next",total:P.value,"page-sizes":[20,50,100],"page-size":C.size,"current-page":C.current,"onUpdate:currentPage":e[3]||(e[3]=a=>C.current=a),onSizeChange:ae,onCurrentChange:le},null,8,["total","page-size","current-page"])])]),o(f,{modelValue:g.visible,"onUpdate:modelValue":e[4]||(e[4]=a=>g.visible=a),title:"扫描历史详情",size:"55vw","min-size":580,"max-size":900},{default:r(()=>[g.item?(p(),v("div",Ie,[e[13]||(e[13]=c("div",{class:"en-section-title"},"基础信息",-1)),c("div",Te,[o(m,{column:1,border:"","label-width":"120px"},{default:r(()=>[o(s,{label:"事件编号"},{default:r(()=>[b(k(g.item.eventCode),1)]),_:1}),o(s,{label:"任务编号"},{default:r(()=>[b(k(g.item.taskBizId),1)]),_:1}),o(s,{label:"状态"},{default:r(()=>[b(k(J(g.item.status)),1)]),_:1}),o(s,{label:"开始时间"},{default:r(()=>[b(k(g.item.startedAt),1)]),_:1}),o(s,{label:"结束时间"},{default:r(()=>[b(k(g.item.finishedAt),1)]),_:1}),o(s,{label:"摘要"},{default:r(()=>[b(k(g.item.summary),1)]),_:1})]),_:1})]),A.value.length?(p(),v("div",Be,"执行详情")):$("",!0),A.value.length?(p(),v("div",Ve,[o(m,{column:1,border:"","label-width":"120px"},{default:r(()=>[(p(!0),v(N,null,E(A.value,a=>(p(),j(s,{key:a.label,label:a.label},{default:r(()=>[c("span",{class:"en-meta-line",innerHTML:Z(a.label,a.value||"-")},null,8,Le)]),_:2},1032,["label"]))),128))]),_:1})])):$("",!0),M.value.length?(p(),v("div",$e,[c("div",Ae,[(p(!0),v(N,null,E(M.value,a=>(p(),j(L,{key:a.key,shadow:"never",class:"en-subtask-card"},{header:r(()=>[c("div",Ne,[c("span",He,k(a.title),1)])]),default:r(()=>{var B;return[c("div",Me,[(B=a.metaItems)!=null&&B.length?(p(),v("div",Oe,[o(m,{column:1,border:"","label-width":"120px"},{default:r(()=>[(p(!0),v(N,null,E(a.metaItems,U=>(p(),j(s,{key:U.label,label:U.label},{default:r(()=>[c("span",{class:"en-meta-line",innerHTML:Z(U.label,U.value||"-")},null,8,Re)]),_:2},1032,["label"]))),128))]),_:2},1024)])):$("",!0),a.detailText?(p(),v("div",Ue,[e[12]||(e[12]=c("div",{class:"en-detail-block-title"},"明细记录",-1)),c("pre",Ee,[c("code",null,k(a.detailText),1)])])):$("",!0)])]}),_:2},1024))),128))])])):$("",!0),!A.value.length&&!M.value.length?(p(),v("div",je," 暂无 ")):$("",!0)])):(p(),v("div",ze,"暂无"))]),_:1},8,["modelValue"])],64)}}},qe=me(De,[["__scopeId","data-v-b6f0ecde"]]);export{qe as default};
