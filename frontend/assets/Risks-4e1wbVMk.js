import{_ as fe,a as w,r as I,k as G,o as $,h as g,c as z,d as u,e as s,w as a,f,l as ke,F as O,n as X,g as h,m as j,p as Q,j as d,t as m,E as k,x as U}from"./index-8jM1g0LY.js";import{g as ge}from"./bizDict-CjwNfxYx.js";const ye={class:"en-page"},_e={class:"en-toolbar"},ve={class:"en-table-wrap"},be={class:"en-footer"},Ce={key:0},we={key:1},Se={class:"en-risk-blocks"},he={class:"en-risk-block"},Re={class:"en-risk-code en-risk-code--summary"},Ve={class:"en-risk-block"},Ne={class:"en-risk-code en-risk-code--payload"},ze={class:"en-risk-block"},xe={class:"en-risk-code en-risk-code--payload"},Ee={class:"en-toolbar",style:{padding:"0","margin-top":"8px"}},De={__name:"Risks",setup(Ie){const x=w([]),P=w(0),_=I({status:"UNHANDLED",keyword:""}),v=I({current:1,size:20}),n=I({visible:!1,loading:!1,item:{},logs:[]}),r=I({visible:!1,loading:!1,riskCode:"",toStatus:"",remark:""}),V=w([]),T=w([]),H=w(),B=w(),b=w(new Set),W=G(()=>Array.from(b.value).length),R=w(new Set),K=G(()=>Array.from(R.value).length),C=async(t=!1)=>{var l,y;const e={page:v.current,size:v.size};_.status&&(e.status=_.status),_.keyword&&(e.keyword=_.keyword);const{data:i}=await g.get("/api/risks",{params:e});x.value=(((l=i==null?void 0:i.data)==null?void 0:l.rows)||[]).map(c=>({...c})),P.value=((y=i==null?void 0:i.data)==null?void 0:y.total)||0,t&&(b.value=new Set),await X(),ee()},M=async()=>{v.current=1,await C(!0)},J=t=>{v.size=t,v.current=1,C()},Y=()=>{C()},Z=t=>{const e=new Set(x.value.map(l=>l.riskCode)),i=new Set(b.value);for(const l of e)i.delete(l);for(const l of t||[])l!=null&&l.riskCode&&i.add(l.riskCode);b.value=i},ee=()=>{const t=H.value;if(t)try{t.clearSelection();for(const e of x.value)b.value.has(e.riskCode)&&t.toggleRowSelection(e,!0)}catch{}},te=t=>{r.riskCode=t.riskCode,r.toStatus=t.status,r.remark="",r.visible=!0},se=async()=>{var t,e;if(!r.toStatus){k.error("请选择目标状态");return}r.loading=!0;try{await g.post(`/api/risks/${encodeURIComponent(r.riskCode)}/status`,{toStatus:r.toStatus,remark:r.remark}),k.success("已更新"),r.visible=!1,await C()}catch(i){k.error(((e=(t=i==null?void 0:i.response)==null?void 0:t.data)==null?void 0:e.message)||"更新失败")}finally{r.loading=!1}},le=async t=>{var e,i,l,y;n.visible=!0,n.loading=!0,R.value=new Set;try{const[c,p]=await Promise.all([g.get(`/api/risks/${encodeURIComponent(t.riskCode)}`),g.get(`/api/risks/${encodeURIComponent(t.riskCode)}/logs`)]);n.item=((e=c.data)==null?void 0:e.data)||{},n.logs=((i=p.data)==null?void 0:i.data)||[],await X(),(y=(l=B.value)==null?void 0:l.clearSelection)==null||y.call(l)}catch{k.error("加载失败")}finally{n.loading=!1}},oe=t=>{R.value=new Set((t||[]).map(e=>e.id))},ae=async t=>{var e,i;if(t!=null&&t.id){try{await U.confirm("确认删除该日志？此操作不可恢复。","删除确认",{type:"warning"})}catch{return}try{await g.delete(`/api/risks/logs/${encodeURIComponent(t.id)}`),k.success("已删除");const{data:l}=await g.get(`/api/risks/${encodeURIComponent(n.item.riskCode)}/logs`);n.logs=(l==null?void 0:l.data)||[],R.value=new Set}catch(l){k.error(((i=(e=l==null?void 0:l.response)==null?void 0:e.data)==null?void 0:i.message)||"删除失败")}}},ie=async()=>{var e,i;const t=Array.from(R.value);if(t.length!==0){try{await U.confirm(`确认删除选中的 ${t.length} 条日志？此操作不可恢复。`,"删除确认",{type:"warning"})}catch{return}try{await g.post("/api/risks/logs/batch-delete",{ids:t}),k.success("已删除");const{data:l}=await g.get(`/api/risks/${encodeURIComponent(n.item.riskCode)}/logs`);n.logs=(l==null?void 0:l.data)||[],R.value=new Set}catch(l){k.error(((i=(e=l==null?void 0:l.response)==null?void 0:e.data)==null?void 0:i.message)||"删除失败")}}},ne=async t=>{var e,i;if(t!=null&&t.riskCode){try{await U.confirm(`确认删除风险 ${t.riskCode}？`,"删除确认",{type:"warning"})}catch{return}try{await g.delete(`/api/risks/${encodeURIComponent(t.riskCode)}`),k.success("已删除"),b.value.delete(t.riskCode),await C()}catch(l){k.error(((i=(e=l==null?void 0:l.response)==null?void 0:e.data)==null?void 0:i.message)||"删除失败")}}},re=async()=>{var e,i;const t=Array.from(b.value);if(t.length!==0){try{await U.confirm(`确认删除选中的 ${t.length} 条风险？`,"删除确认",{type:"warning"})}catch{return}try{await g.post("/api/risks/batch-delete",{riskCodes:t}),k.success("已删除"),b.value=new Set,await C()}catch(l){k.error(((i=(e=l==null?void 0:l.response)==null?void 0:e.data)==null?void 0:i.message)||"删除失败")}}},E=t=>{const e=V.value.find(i=>i.itemCode===t);return(e==null?void 0:e.itemName)||t||"未知"},F=t=>{const e=String(t||"").trim();if(!e)return"-";const i=T.value.find(l=>String(l.ruleCode||"")===e);return(i==null?void 0:i.ruleName)||e},D=t=>t==="UNHANDLED"?"danger":t==="RESOLVED"?"success":"info";return $(C),$(async()=>{try{const{data:t}=await g.get("/api/assess/config/rules");T.value=(t==null?void 0:t.data)||[]}catch{T.value=[{ruleCode:"HIGH_RISK_PORT_OPEN",ruleName:"高危端口开放"},{ruleCode:"ADMIN_PATH_EXPOSED",ruleName:"管理路径暴露"},{ruleCode:"SENSITIVE_PATH_EXPOSED",ruleName:"敏感路径暴露"},{ruleCode:"FRAMEWORK_FINGERPRINT_EXPOSED",ruleName:"框架指纹暴露"}]}}),$(async()=>{try{V.value=await ge("RISK_STATUS")}catch{V.value=[{itemCode:"UNHANDLED",itemName:"未处理"},{itemCode:"IGNORED",itemName:"已忽略"},{itemCode:"RESOLVED",itemName:"已解决"}]}}),(t,e)=>{const i=f("el-option"),l=f("el-select"),y=f("el-input"),c=f("el-button"),p=f("el-table-column"),N=f("el-tag"),q=f("el-table"),de=f("el-pagination"),S=f("el-descriptions-item"),ue=f("el-descriptions"),pe=f("el-drawer"),A=f("el-form-item"),ce=f("el-form"),me=f("el-dialog");return h(),z(O,null,[u("div",ye,[u("div",_e,[s(l,{modelValue:_.status,"onUpdate:modelValue":e[0]||(e[0]=o=>_.status=o),placeholder:"状态",clearable:"",style:{width:"170px"}},{default:a(()=>[(h(!0),z(O,null,j(V.value,o=>(h(),Q(i,{key:o.itemCode,label:o.itemName,value:o.itemCode},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),s(y,{modelValue:_.keyword,"onUpdate:modelValue":e[1]||(e[1]=o=>_.keyword=o),placeholder:"标题/资产编码关键词",clearable:"",style:{width:"260px"},onKeyup:ke(M,["enter"])},null,8,["modelValue"]),s(c,{onClick:M},{default:a(()=>[...e[9]||(e[9]=[d("查询",-1)])]),_:1}),s(c,{type:"danger",plain:"",disabled:W.value===0,onClick:re},{default:a(()=>[...e[10]||(e[10]=[d(" 批量删除 ",-1)])]),_:1},8,["disabled"]),e[12]||(e[12]=u("div",{class:"spacer"},null,-1)),s(c,{onClick:C},{default:a(()=>[...e[11]||(e[11]=[d("刷新",-1)])]),_:1})]),u("div",ve,[s(q,{ref_key:"riskTableRef",ref:H,data:x.value,height:"100%",border:"","row-key":"riskCode","reserve-selection":!0,onSelectionChange:Z},{default:a(()=>[s(p,{type:"selection",width:"46"}),s(p,{prop:"riskCode",label:"风险编号",width:"240","show-overflow-tooltip":""}),s(p,{prop:"assetCode",label:"资产编码",width:"240","show-overflow-tooltip":""}),s(p,{prop:"riskType",label:"类型",width:"210","show-overflow-tooltip":""},{default:a(({row:o})=>[d(m(F(o.riskType)),1)]),_:1}),s(p,{prop:"title",label:"标题","min-width":"240","show-overflow-tooltip":""}),s(p,{prop:"status",label:"状态",width:"120"},{default:a(({row:o})=>[s(N,{size:"small",type:D(o.status)},{default:a(()=>[d(m(E(o.status)),1)]),_:2},1032,["type"])]),_:1}),s(p,{prop:"detectedAt",label:"发现时间",width:"170"}),s(p,{label:"操作",width:"280",fixed:"right"},{default:a(({row:o})=>[s(c,{size:"small",onClick:L=>le(o)},{default:a(()=>[...e[13]||(e[13]=[d("详情",-1)])]),_:1},8,["onClick"]),s(c,{size:"small",type:"primary",plain:"",onClick:L=>te(o)},{default:a(()=>[...e[14]||(e[14]=[d("处置",-1)])]),_:1},8,["onClick"]),s(c,{size:"small",type:"danger",plain:"",onClick:L=>ne(o)},{default:a(()=>[...e[15]||(e[15]=[d("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])]),u("div",be,[s(de,{class:"en-pagination",layout:"total, sizes, prev, pager, next",total:P.value,"page-sizes":[20,50,100],"page-size":v.size,"current-page":v.current,"onUpdate:currentPage":e[2]||(e[2]=o=>v.current=o),onSizeChange:J,onCurrentChange:Y},null,8,["total","page-size","current-page"])])]),s(pe,{modelValue:n.visible,"onUpdate:modelValue":e[3]||(e[3]=o=>n.visible=o),title:"风险详情",size:"55vw","min-size":580,"max-size":900},{default:a(()=>[n.loading?(h(),z("div",Ce,"加载中...")):(h(),z("div",we,[e[21]||(e[21]=u("div",{class:"en-risk-section-title"},"风险详情",-1)),s(ue,{column:1,border:"",style:{"margin-top":"8px"}},{default:a(()=>[s(S,{label:"风险编号"},{default:a(()=>[d(m(n.item.riskCode),1)]),_:1}),s(S,{label:"资产编码"},{default:a(()=>[d(m(n.item.assetCode),1)]),_:1}),s(S,{label:"类型"},{default:a(()=>[d(m(F(n.item.riskType)),1)]),_:1}),s(S,{label:"标题"},{default:a(()=>[d(m(n.item.title),1)]),_:1}),s(S,{label:"状态"},{default:a(()=>[s(N,{size:"small",type:D(n.item.status)},{default:a(()=>[d(m(E(n.item.status)),1)]),_:1},8,["type"])]),_:1}),s(S,{label:"首次发现时间"},{default:a(()=>[d(m(n.item.firstDetectedAt||"-"),1)]),_:1}),s(S,{label:"最近发现时间"},{default:a(()=>[d(m(n.item.detectedAt),1)]),_:1})]),_:1}),u("div",Se,[u("div",he,[e[16]||(e[16]=u("div",{class:"en-risk-block-title"},"摘要",-1)),u("pre",Re,[u("code",null,m(n.item.detail||"-"),1)])]),u("div",Ve,[e[17]||(e[17]=u("div",{class:"en-risk-block-title"},"Request",-1)),u("pre",Ne,[u("code",null,m(n.item.requestData||"-"),1)])]),u("div",ze,[e[18]||(e[18]=u("div",{class:"en-risk-block-title"},"Response",-1)),u("pre",xe,[u("code",null,m(n.item.responseData||"-"),1)])])]),e[22]||(e[22]=u("div",{class:"en-risk-section-title",style:{"margin-top":"12px"}},"风险日志",-1)),u("div",Ee,[s(c,{type:"danger",plain:"",disabled:K.value===0,onClick:ie},{default:a(()=>[...e[19]||(e[19]=[d(" 批量删除 ",-1)])]),_:1},8,["disabled"]),s(N,{size:"small",effect:"plain"},{default:a(()=>[d(m(K.value)+" 已选",1)]),_:1})]),s(q,{ref_key:"riskLogTableRef",ref:B,data:n.logs,height:"320px",border:"","row-key":"id","reserve-selection":!0,style:{"margin-top":"8px"},onSelectionChange:oe},{default:a(()=>[s(p,{type:"selection",width:"46"}),s(p,{prop:"createdAt",label:"时间",width:"170"}),s(p,{prop:"fromStatus",label:"原状态",width:"90"},{default:a(({row:o})=>[s(N,{size:"small",type:D(o.fromStatus)},{default:a(()=>[d(m(E(o.fromStatus)),1)]),_:2},1032,["type"])]),_:1}),s(p,{prop:"toStatus",label:"新状态",width:"90"},{default:a(({row:o})=>[s(N,{size:"small",type:D(o.toStatus)},{default:a(()=>[d(m(E(o.toStatus)),1)]),_:2},1032,["type"])]),_:1}),s(p,{prop:"operator",label:"操作人",width:"120","show-overflow-tooltip":""}),s(p,{prop:"remark",label:"备注","min-width":"140","show-overflow-tooltip":""}),s(p,{label:"操作",width:"120",fixed:"right"},{default:a(({row:o})=>[s(c,{size:"small",type:"danger",plain:"",onClick:L=>ae(o)},{default:a(()=>[...e[20]||(e[20]=[d("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])]))]),_:1},8,["modelValue"]),s(me,{modelValue:r.visible,"onUpdate:modelValue":e[8]||(e[8]=o=>r.visible=o),title:"风险处置",width:"520px"},{footer:a(()=>[s(c,{disabled:r.loading,onClick:e[7]||(e[7]=o=>r.visible=!1)},{default:a(()=>[...e[23]||(e[23]=[d("取消",-1)])]),_:1},8,["disabled"]),s(c,{type:"primary",loading:r.loading,onClick:se},{default:a(()=>[...e[24]||(e[24]=[d("提交",-1)])]),_:1},8,["loading"])]),default:a(()=>[s(ce,{"label-width":"90px"},{default:a(()=>[s(A,{label:"风险编号"},{default:a(()=>[s(y,{modelValue:r.riskCode,"onUpdate:modelValue":e[4]||(e[4]=o=>r.riskCode=o),readonly:""},null,8,["modelValue"])]),_:1}),s(A,{label:"目标状态",required:""},{default:a(()=>[s(l,{modelValue:r.toStatus,"onUpdate:modelValue":e[5]||(e[5]=o=>r.toStatus=o),style:{width:"100%"}},{default:a(()=>[(h(!0),z(O,null,j(V.value,o=>(h(),Q(i,{key:o.itemCode,label:o.itemName,value:o.itemCode},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),s(A,{label:"备注"},{default:a(()=>[s(y,{modelValue:r.remark,"onUpdate:modelValue":e[6]||(e[6]=o=>r.remark=o),type:"textarea",rows:3,placeholder:"可选：记录处置原因/证据链接"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])],64)}}},Ae=fe(De,[["__scopeId","data-v-1ee21ff6"]]);export{Ae as default};
