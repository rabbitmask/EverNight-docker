import{_ as le,r as W,a as U,k as M,z as ne,o as Q,f as g,p as B,g as C,w as a,d as y,c as L,F as oe,e as t,v as P,j as b,t as I,h as D,E as h,x as H}from"./index-s_Bt94In.js";import{_ as se}from"./DictItemManager-DTRiTg8l.js";const ie={style:{display:"flex","justify-content":"space-between","align-items":"center",gap:"12px"}},de={style:{"min-width":"0"}},re={style:{"font-weight":"700"}},ce={class:"en-muted",style:{"font-size":"12px","margin-top":"2px"}},ue={key:0},pe={key:1},fe={key:2},me={style:{display:"flex","align-items":"center",gap:"8px"}},ve={class:"en-card-body",style:{display:"flex","flex-direction":"column","min-height":"0"}},ye={class:"en-toolbar",style:{padding:"0",gap:"8px","flex-wrap":"wrap"}},_e={key:2,style:{display:"flex","justify-content":"flex-end",gap:"8px","margin-top":"10px"}},ge={__name:"DictSingleEditor",props:{code:{type:String,required:!0}},setup(G){const m=G,r=W({dictCode:"",dictName:"",enabled:0,version:""}),c=U(""),p=U(""),d=U(!1),E=U(!1),k=U(!1),w=U(),n=M(()=>r.dictName||m.code),u=M(()=>m.code==="common_ports"?"常见端口字典：每行一个端口或端口范围（如 80 或 22-25），用于端口扫描“常见端口”范围。":m.code==="subdomain"?"子域名字典：每行一个子域名前缀（如 www/api/test），用于 DNS 爆破。":m.code==="cdn_fingerprint"?"CDN 指纹字典：每行一个域名指纹（如 cloudfront.net / cloudflare.net），用于 CNAME 指纹匹配。":"每行一个值；空行/以 # 开头的行会被忽略。"),T=/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/,N=/^[a-z0-9.-]+$/,S=o=>String(o||"").replace(/\r\n/g,`
`).replace(/\r/g,`
`).split(`
`).map(s=>String(s||"").trim()).filter(s=>s&&!s.startsWith("#")),V=o=>{const e=S(o),s=new Set;let l=0;if(m.code==="common_ports"){const f=new Map;for(const i of e){const F=String(i||"").replace(/\s+/g,"");if(!F)continue;if(!/^[0-9]+(-[0-9]+)?$/.test(F)){l++;continue}const R=F.split("-"),$=parseInt(R[0],10),j=R.length===2?parseInt(R[1],10):$;if(!Number.isFinite($)||!Number.isFinite(j)||$<1||$>65535||j<1||j>65535||j<$){l++;continue}const q=$===j?String($):`${$}-${j}`;f.has(q)||f.set(q,{text:q,start:$,end:j})}const v=Array.from(f.values());return v.sort((i,F)=>i.start-F.start||i.end-F.end||i.text.localeCompare(F.text)),{lines:v.map(i=>i.text),invalid:l}}if(m.code==="subdomain"){for(const v of e){const i=v.toLowerCase();if(!T.test(i)){l++;continue}s.add(i)}const f=Array.from(s);return f.sort((v,i)=>v.localeCompare(i)),{lines:f,invalid:l}}if(m.code==="cdn_fingerprint"){for(const v of e){let i=v.toLowerCase();if(i.endsWith(".")&&(i=i.slice(0,-1)),i.startsWith(".")&&(i=i.slice(1)),!i||!N.test(i)){l++;continue}s.add(i)}const f=Array.from(s);return f.sort((v,i)=>v.localeCompare(i)),{lines:f,invalid:l}}for(const f of e)s.add(f);const A=Array.from(s);return A.sort((f,v)=>f.localeCompare(v)),{lines:A,invalid:0}},x=M(()=>{const o=d.value?p.value:c.value,e=S(o).length,{lines:s,invalid:l}=V(o);return{total:e,unique:s.length,invalid:l}}),_=async()=>{var o;E.value=!0;try{const{data:e}=await D.get("/api/dicts"),l=((e==null?void 0:e.data)||[]).find(f=>f.dictCode===m.code)||{};r.dictCode=l.dictCode||"",r.dictName=l.dictName||"",r.enabled=l.enabled??0,r.version=l.version||"";const A=await D.get(`/api/dicts/${encodeURIComponent(m.code)}/lines`);c.value=(((o=A.data)==null?void 0:o.data)||[]).join(`
`),d.value||(p.value=c.value)}catch{h.error("加载失败")}finally{E.value=!1}},O=async()=>{r.dictCode&&(d.value=!0,p.value=c.value)},K=async()=>{if(!d.value)return;if(!((p.value||"")===(c.value||"")))try{await H.confirm("内容未保存，确认放弃修改？","提示",{type:"warning"})}catch{return}d.value=!1,p.value=c.value},z=async()=>{if(!d.value)return;const{lines:o}=V(p.value);p.value=o.join(`
`),h.success("已去重/排序")},X=async()=>{if(d.value){try{await H.confirm("确认清空当前编辑内容？","提示",{type:"warning"})}catch{return}p.value=""}},Y=async()=>{var o,e;d.value&&((e=(o=w.value)==null?void 0:o.click)==null||e.call(o))},Z=async o=>{var s,l;if(!d.value)return;const e=(l=(s=o==null?void 0:o.target)==null?void 0:s.files)==null?void 0:l[0];if(e)try{const A=await e.text(),{lines:f,invalid:v}=V(A);p.value=f.join(`
`),h.success(v?`已导入（忽略 ${v} 行不合法）`:"已导入")}catch{h.error("导入失败")}finally{try{o.target.value=""}catch{}}},ee=async()=>{const o=c.value||"",e=new Blob([o],{type:"text/plain;charset=utf-8"}),s=URL.createObjectURL(e),l=document.createElement("a");l.href=s,l.download=`${m.code}.txt`,l.click(),URL.revokeObjectURL(s)},te=async()=>{var o,e;k.value=!0;try{const{lines:s,invalid:l}=V(p.value);l&&h.warning(`已自动忽略 ${l} 行不合法内容`),await D.post(`/api/dicts/${encodeURIComponent(m.code)}/content`,{content:s.join(`
`)}),h.success("已保存"),d.value=!1,await _()}catch(s){h.error(((e=(o=s==null?void 0:s.response)==null?void 0:o.data)==null?void 0:e.message)||"保存失败")}finally{k.value=!1}},ae=async()=>{try{await D.post(`/api/dicts/${encodeURIComponent(m.code)}/enabled`,{enabled:r.enabled}),h.success("已更新"),await _()}catch{h.error("更新失败"),await _()}};return ne(()=>m.code,()=>{d.value=!1,c.value="",p.value="",r.dictCode="",r.dictName="",r.enabled=0,r.version="",_()}),Q(_),(o,e)=>{const s=g("el-switch"),l=g("el-button"),A=g("el-empty"),f=g("el-alert"),v=g("el-tag"),i=g("el-input"),F=g("el-card");return C(),B(F,{class:"en-card-fill",shadow:"never"},{header:a(()=>[y("div",ie,[y("div",de,[y("div",re,I(n.value),1),y("div",ce,[y("span",null,I(r.dictCode||m.code),1),r.version?(C(),L("span",ue," · v"+I(r.version),1)):P("",!0),x.value.total?(C(),L("span",pe," · "+I(x.value.total)+" 行",1)):P("",!0),x.value.unique&&x.value.unique!==x.value.total?(C(),L("span",fe," · 去重后 "+I(x.value.unique)+" 行",1)):P("",!0)])]),y("div",me,[t(s,{modelValue:r.enabled,"onUpdate:modelValue":e[0]||(e[0]=R=>r.enabled=R),"active-value":1,"inactive-value":0,disabled:!r.dictCode,onChange:ae},null,8,["modelValue","disabled"]),t(l,{size:"small",disabled:E.value,onClick:_},{default:a(()=>[...e[3]||(e[3]=[b("刷新",-1)])]),_:1},8,["disabled"]),t(l,{size:"small",disabled:!r.dictCode||E.value,onClick:O},{default:a(()=>[b(I(d.value?"继续编辑":"编辑"),1)]),_:1},8,["disabled"])])])]),default:a(()=>[y("div",ve,[r.dictCode?(C(),L(oe,{key:1},[t(f,{title:u.value,type:"info","show-icon":"",closable:!1,style:{"margin-bottom":"10px"}},null,8,["title"]),y("div",ye,[t(l,{size:"small",disabled:E.value,onClick:ee},{default:a(()=>[...e[4]||(e[4]=[b("导出",-1)])]),_:1},8,["disabled"]),t(l,{size:"small",disabled:!d.value||k.value,onClick:z},{default:a(()=>[...e[5]||(e[5]=[b("去重/排序",-1)])]),_:1},8,["disabled"]),t(l,{size:"small",disabled:!d.value||k.value,onClick:Y},{default:a(()=>[...e[6]||(e[6]=[b("导入文件",-1)])]),_:1},8,["disabled"]),t(l,{size:"small",type:"danger",plain:"",disabled:!d.value||k.value,onClick:X},{default:a(()=>[...e[7]||(e[7]=[b("清空",-1)])]),_:1},8,["disabled"]),e[8]||(e[8]=y("div",{class:"spacer"},null,-1)),x.value.invalid?(C(),B(v,{key:0,size:"small",type:"warning",effect:"plain"},{default:a(()=>[b(I(x.value.invalid)+" 行不合法已忽略",1)]),_:1})):P("",!0),t(v,{size:"small",effect:"plain"},{default:a(()=>[b(I(d.value?"编辑模式":"只读模式"),1)]),_:1})]),y("input",{ref_key:"fileRef",ref:w,type:"file",accept:".txt,.list,.csv",style:{display:"none"},onChange:Z},null,544),d.value?(C(),B(i,{key:0,modelValue:p.value,"onUpdate:modelValue":e[1]||(e[1]=R=>p.value=R),type:"textarea",readonly:k.value,class:"en-card-body",autosize:{minRows:18,maxRows:40},style:{flex:"1","min-height":"480px"},placeholder:"每行一个值；空行/以 # 开头的行会被忽略"},null,8,["modelValue","readonly"])):(C(),B(i,{key:1,modelValue:c.value,"onUpdate:modelValue":e[2]||(e[2]=R=>c.value=R),type:"textarea",readonly:"",class:"en-card-body",autosize:{minRows:18,maxRows:40},style:{flex:"1","min-height":"480px"}},null,8,["modelValue"])),d.value?(C(),L("div",_e,[t(l,{disabled:k.value,onClick:K},{default:a(()=>[...e[9]||(e[9]=[b("取消",-1)])]),_:1},8,["disabled"]),t(l,{type:"primary",loading:k.value,onClick:te},{default:a(()=>[...e[10]||(e[10]=[b("保存",-1)])]),_:1},8,["loading"])])):P("",!0)],64)):(C(),B(A,{key:0,description:"未找到字典元数据",style:{margin:"auto"}}))])]),_:1})}}},J=le(ge,[["__scopeId","data-v-5833ebfd"]]),be={class:"en-page"},we={style:{display:"flex","justify-content":"space-between","align-items":"center"}},xe={style:{display:"flex",gap:"8px"}},he={style:{display:"flex","justify-content":"space-between","align-items":"center"}},Ce={style:{display:"flex",gap:"8px"}},Ne={__name:"ScanConfig",setup(G){const m=U(!1),r=U(!1),c=W({enabled:0,email:"",apiKey:""}),p=W({ipThreshold:5}),d=async()=>{const{data:w}=await D.get("/api/scan/config"),n=(w==null?void 0:w.data)||[],u=x=>n.find(_=>_.configKey===x)||{},T=u("fofa_email"),N=u("fofa_api_key");c.email=T.configValue||"",c.apiKey=N.configValue||"",c.enabled=T.enabled===1&&N.enabled===1?1:0;const S=u("cdn_suspect_ip_threshold"),V=parseInt(S.configValue||"5",10);p.ipThreshold=Number.isFinite(V)?V:5},E=async()=>{var w,n;m.value=!0;try{const u=c.enabled?1:0;await Promise.all([D.post("/api/scan/config",{key:"fofa_email",value:c.email,enabled:u}),D.post("/api/scan/config",{key:"fofa_api_key",value:c.apiKey,enabled:u})]),h.success("已保存"),await d()}catch(u){h.error(((n=(w=u==null?void 0:u.response)==null?void 0:w.data)==null?void 0:n.message)||"保存失败")}finally{m.value=!1}},k=async()=>{var w,n;r.value=!0;try{const u=Number.isFinite(p.ipThreshold)?p.ipThreshold:5;await D.post("/api/scan/config",{key:"cdn_suspect_ip_threshold",value:String(u),enabled:1}),h.success("已保存"),await d()}catch(u){h.error(((n=(w=u==null?void 0:u.response)==null?void 0:w.data)==null?void 0:n.message)||"保存失败")}finally{r.value=!1}};return Q(d),(w,n)=>{const u=g("el-button"),T=g("el-switch"),N=g("el-form-item"),S=g("el-input"),V=g("el-form"),x=g("el-card"),_=g("el-tab-pane"),O=g("el-tabs"),K=g("el-input-number");return C(),L("div",be,[t(O,{style:{flex:"1","min-height":"0"}},{default:a(()=>[t(_,{label:"集成配置"},{default:a(()=>[t(x,{shadow:"never"},{header:a(()=>[y("div",we,[n[6]||(n[6]=y("div",{style:{"font-weight":"700"}},"FOFA 集成",-1)),y("div",xe,[t(u,{size:"small",onClick:d},{default:a(()=>[...n[4]||(n[4]=[b("刷新",-1)])]),_:1}),t(u,{size:"small",type:"primary",loading:m.value,onClick:E},{default:a(()=>[...n[5]||(n[5]=[b("保存",-1)])]),_:1},8,["loading"])])])]),default:a(()=>[t(V,{"label-width":"140px",style:{"max-width":"720px"}},{default:a(()=>[t(N,{label:"启用 FOFA"},{default:a(()=>[t(T,{modelValue:c.enabled,"onUpdate:modelValue":n[0]||(n[0]=z=>c.enabled=z),"active-value":1,"inactive-value":0},null,8,["modelValue"])]),_:1}),t(N,{label:"FOFA Email"},{default:a(()=>[t(S,{modelValue:c.email,"onUpdate:modelValue":n[1]||(n[1]=z=>c.email=z),placeholder:"用于 FOFA API 鉴权"},null,8,["modelValue"])]),_:1}),t(N,{label:"FOFA API Key"},{default:a(()=>[t(S,{modelValue:c.apiKey,"onUpdate:modelValue":n[2]||(n[2]=z=>c.apiKey=z),placeholder:"用于 FOFA API 鉴权","show-password":""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),t(_,{label:"扫描字典"},{default:a(()=>[t(O,null,{default:a(()=>[t(_,{label:"子域名字典"},{default:a(()=>[t(J,{code:"subdomain"})]),_:1}),t(_,{label:"常见端口字典"},{default:a(()=>[t(J,{code:"common_ports"})]),_:1})]),_:1})]),_:1}),t(_,{label:"CDN 指纹"},{default:a(()=>[t(O,null,{default:a(()=>[t(_,{label:"指纹字典"},{default:a(()=>[t(se,{code:"cdn_fingerprint","value-label":"指纹","value-placeholder":"例如：cloudfront.net","search-placeholder":"搜索 指纹/规则"})]),_:1}),t(_,{label:"CDN 配置"},{default:a(()=>[t(x,{shadow:"never"},{header:a(()=>[y("div",he,[n[9]||(n[9]=y("div",{style:{"font-weight":"700"}},"CDN 判定阈值",-1)),y("div",Ce,[t(u,{size:"small",onClick:d},{default:a(()=>[...n[7]||(n[7]=[b("刷新",-1)])]),_:1}),t(u,{size:"small",type:"primary",loading:r.value,onClick:k},{default:a(()=>[...n[8]||(n[8]=[b("保存",-1)])]),_:1},8,["loading"])])])]),default:a(()=>[t(V,{"label-width":"140px",style:{"max-width":"720px"}},{default:a(()=>[t(N,{label:"疑似 CDN 阈值"},{default:a(()=>[t(K,{modelValue:p.ipThreshold,"onUpdate:modelValue":n[3]||(n[3]=z=>p.ipThreshold=z),min:2,max:100,"controls-position":"right"},null,8,["modelValue"]),n[10]||(n[10]=y("div",{class:"en-muted",style:{"font-size":"12px","margin-left":"10px","white-space":"nowrap"}}," IP数 ≥ 阈值：疑似 CDN 不入认领；1<IP数<阈值：疑似负载均衡入认领。 ",-1))]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})])}}};export{Ne as default};
