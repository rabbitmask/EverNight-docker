import{_ as we,a as g,r as q,k as G,o as j,c as k,d as p,e as o,w as s,f as r,l as be,F as S,h as I,n as H,y as ke,g as c,m as U,p as V,j as m,t as x,u as K,q as Ve,s as Te,v as Se,E as v,x as Y}from"./index-BFugLfXi.js";import{G as Ne,c as Ae}from"./clipboard-B-lzJjel.js";import{g as L}from"./bizDict-BGApEC7U.js";const he={class:"en-page"},Ie={class:"en-toolbar"},Ue={class:"en-table-wrap"},xe={class:"en-link-trigger"},Le={class:"en-drop-item"},Ee={class:"en-drop-item"},Re={key:1},ze={class:"en-footer"},Pe={class:"en-form-panel"},qe={class:"en-readonly-block"},De={__name:"Claims",setup(Oe){const N=g([]),D=g(0),y=q({discoveredType:"",keyword:""}),C=q({current:1,size:20}),O=g(),_=g(new Set),Q=ke(),A=g([]),E=g([]),R=g([]),T=g([]),$=G(()=>{var l,e,i;return((l=T.value.find(a=>a.itemCode==="可用"))==null?void 0:l.itemCode)||((i=(e=T.value)==null?void 0:e[0])==null?void 0:i.itemCode)||"可用"}),J=G(()=>Array.from(_.value).length),z=g(),X={assetName:[{required:!0,message:"资产名称不能为空",trigger:"blur"}],assetType:[{required:!0,message:"资产类型不能为空",trigger:"change"}],importance:[{required:!0,message:"业务重要性不能为空",trigger:"change"}],assetStatus:[{required:!0,message:"资产状态不能为空",trigger:"change"}],geoLocation:[{required:!0,message:"地理位置不能为空",trigger:"change"}]},n=q({visible:!1,loading:!1,claimCode:"",discoveredAddress:"",discoveredTitle:"",discoveredIp:"",geoLocationRef:"",form:{assetName:"",assetType:"",importance:"",assetStatus:$.value,owner:"",department:"",techStack:"",assetDesc:"",geoLocation:""}}),w=async(l=!1)=>{var a,d;const e={page:C.current,size:C.size};y.discoveredType&&(e.discoveredType=y.discoveredType),y.keyword&&(e.keyword=y.keyword);const{data:i}=await I.get("/api/claims",{params:e});N.value=((a=i==null?void 0:i.data)==null?void 0:a.rows)||[],D.value=((d=i==null?void 0:i.data)==null?void 0:d.total)||0,l&&(_.value=new Set),await H(),oe()},B=async()=>{C.current=1,await w(!0)},Z=l=>{C.size=l,C.current=1,w()},ee=()=>{w()},te=l=>{const e=new Set(N.value.map(a=>a.claimCode)),i=new Set(_.value);for(const a of e)i.delete(a);for(const a of l||[])a!=null&&a.claimCode&&i.add(a.claimCode);_.value=i},oe=()=>{const l=O.value;if(l)try{l.clearSelection();for(const e of N.value)_.value.has(e.claimCode)&&l.toggleRowSelection(e,!0)}catch{}},le=l=>{n.claimCode=l.claimCode,n.discoveredAddress=l.discoveredAddress,n.discoveredTitle=l.discoveredTitle||"",n.discoveredIp=l.discoveredIp||"",n.geoLocationRef=l.geoLocation||"",n.form={assetName:"",assetType:"",importance:"",assetStatus:$.value,owner:"",department:"",techStack:"",assetDesc:"",geoLocation:""},n.visible=!0,H(()=>{var e,i;return(i=(e=z.value)==null?void 0:e.clearValidate)==null?void 0:i.call(e)})},ae=async()=>{var l,e,i,a;n.loading=!0;try{await((e=(l=z.value)==null?void 0:l.validate)==null?void 0:e.call(l)),await I.post(`/api/claims/${encodeURIComponent(n.claimCode)}/claim`,n.form),v.success("认领成功"),n.visible=!1,await w()}catch(d){(a=(i=d==null?void 0:d.response)==null?void 0:i.data)!=null&&a.message?v.error(d.response.data.message):d!=null&&d.message?v.error(d.message):v.error("认领失败")}finally{n.loading=!1}},se=async l=>{var e,i;if(l!=null&&l.claimCode){try{await Y.confirm(`确认删除待认领资产 ${l.claimCode}？`,"删除确认",{type:"warning"})}catch{return}try{await I.delete(`/api/claims/${encodeURIComponent(l.claimCode)}`),v.success("已删除"),_.value.delete(l.claimCode),await w()}catch(a){v.error(((i=(e=a==null?void 0:a.response)==null?void 0:e.data)==null?void 0:i.message)||"删除失败")}}},ne=async()=>{var e,i;const l=Array.from(_.value);if(l.length!==0){try{await Y.confirm(`确认删除选中的 ${l.length} 条待认领资产？`,"删除确认",{type:"warning"})}catch{return}try{await I.post("/api/claims/batch-delete",{claimCodes:l}),v.success("已删除"),_.value=new Set,await w()}catch(a){v.error(((i=(e=a==null?void 0:a.response)==null?void 0:e.data)==null?void 0:i.message)||"删除失败")}}},ie=l=>{l!=null&&l.sourceTaskCode&&Q.push({path:"/scan/history",query:{taskCode:l.sourceTaskCode}})},de=l=>{const e=String(l||"").trim().toLowerCase();return e.startsWith("http://")||e.startsWith("https://")},re=l=>{const e=String(l||"").trim();e&&window.open(e,"_blank","noopener")},me=async(l,e)=>{if(l==="open"){re(e);return}l==="copy"&&(await Ae(e)?v.success("已复制"):v.error((window==null?void 0:window.isSecureContext)===!1?"复制失败（请使用 https 或 localhost 打开）":"复制失败"))};j(w),j(async()=>{try{A.value=await L("CLAIM_DISCOVERED_TYPE")}catch{A.value=[{itemCode:"PORT",itemName:"端口扫描"},{itemCode:"DNS",itemName:"DNS爆破"},{itemCode:"CRT",itemName:"证书透明度查询"},{itemCode:"FOFA",itemName:"网络空间搜索引擎"}]}const l=[{itemCode:"WEB_APP",itemName:"Web 应用"},{itemCode:"API",itemName:"API 接口"},{itemCode:"DOMAIN",itemName:"域名"},{itemCode:"IP",itemName:"IP地址"},{itemCode:"DB",itemName:"数据库"},{itemCode:"OTHER",itemName:"其他"}],e=[{itemCode:"核心业务",itemName:"核心业务"},{itemCode:"重要业务",itemName:"重要业务"},{itemCode:"一般业务",itemName:"一般业务"},{itemCode:"辅助业务",itemName:"辅助业务"}],i=[{itemCode:"可用",itemName:"可用"},{itemCode:"停用",itemName:"停用"}];try{const a=await L("ASSET_TYPE");if(!(a!=null&&a.length))throw new Error("empty dict items");E.value=a}catch{E.value=l}try{const a=await L("ASSET_IMPORTANCE");if(!(a!=null&&a.length))throw new Error("empty dict items");R.value=a}catch{R.value=e}try{const a=await L("ASSET_STATUS");if(!(a!=null&&a.length))throw new Error("empty dict items");T.value=a}catch{T.value=i}});const ue=l=>{const e=A.value.find(i=>i.itemCode===l);return(e==null?void 0:e.itemName)||l||"未知"},M=l=>{const e=String(l||"").trim();if(!e)return"";if(e.startsWith("CN/"))return e.slice(3).split("/").filter(Boolean).join(" ");if(e.startsWith("INTL/")){const i=e.split("/").filter(Boolean),a=i[1]||"",d=i[2]||"";return d?`海外 ${a} ${d}`.trim():`海外 ${a}`.trim()}return e};return(l,e)=>{const i=r("el-option"),a=r("el-select"),d=r("el-input"),b=r("el-button"),f=r("el-table-column"),pe=r("el-tag"),W=r("el-icon"),F=r("el-dropdown-item"),ce=r("el-dropdown-menu"),fe=r("el-dropdown"),ve=r("el-table"),ge=r("el-pagination"),ye=r("el-alert"),P=r("el-divider"),u=r("el-form-item"),Ce=r("el-form"),_e=r("el-dialog");return c(),k(S,null,[p("div",he,[p("div",Ie,[o(a,{modelValue:y.discoveredType,"onUpdate:modelValue":e[0]||(e[0]=t=>y.discoveredType=t),placeholder:"扫描模块",clearable:"",style:{width:"170px"}},{default:s(()=>[(c(!0),k(S,null,U(A.value,t=>(c(),V(i,{key:t.itemCode,label:t.itemName,value:t.itemCode},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),o(d,{modelValue:y.keyword,"onUpdate:modelValue":e[1]||(e[1]=t=>y.keyword=t),placeholder:"地址关键词",style:{width:"260px"},clearable:"",onKeyup:be(B,["enter"])},null,8,["modelValue"]),o(b,{onClick:B},{default:s(()=>[...e[17]||(e[17]=[m("查询",-1)])]),_:1}),o(b,{type:"danger",plain:"",disabled:J.value===0,onClick:ne},{default:s(()=>[...e[18]||(e[18]=[m("批量删除",-1)])]),_:1},8,["disabled"]),e[20]||(e[20]=p("div",{class:"spacer"},null,-1)),o(b,{onClick:w},{default:s(()=>[...e[19]||(e[19]=[m("刷新",-1)])]),_:1})]),p("div",Ue,[o(ve,{ref_key:"claimTableRef",ref:O,data:N.value,height:"100%",border:"","row-key":"claimCode","reserve-selection":!0,onSelectionChange:te},{default:s(()=>[o(f,{type:"selection",width:"46"}),o(f,{prop:"claimCode",label:"待认领资产编码",width:"240","show-overflow-tooltip":""}),o(f,{prop:"discoveredType",label:"扫描模块",width:"150"},{default:s(({row:t})=>[o(pe,{size:"small",effect:"plain"},{default:s(()=>[m(x(ue(t.discoveredType)),1)]),_:2},1024)]),_:1}),o(f,{prop:"discoveredAddress",label:"发现地址","min-width":"260","show-overflow-tooltip":""},{default:s(({row:t})=>[o(fe,{trigger:"click",onCommand:h=>me(h,t.discoveredAddress)},{dropdown:s(()=>[o(ce,null,{default:s(()=>[o(F,{command:"open",disabled:!de(t.discoveredAddress)},{default:s(()=>[p("span",Le,[o(W,null,{default:s(()=>[o(K(Ve))]),_:1}),e[21]||(e[21]=m(" 访问 ",-1))])]),_:1},8,["disabled"]),o(F,{command:"copy"},{default:s(()=>[p("span",Ee,[o(W,null,{default:s(()=>[o(K(Te))]),_:1}),e[22]||(e[22]=m(" 复制 ",-1))])]),_:1})]),_:2},1024)]),default:s(()=>[p("span",xe,x(t.discoveredAddress),1)]),_:2},1032,["onCommand"])]),_:1}),o(f,{prop:"discoveredTitle",label:"标题","min-width":"200","show-overflow-tooltip":""}),o(f,{prop:"discoveredIp",label:"IP",width:"160","show-overflow-tooltip":""}),o(f,{prop:"geoLocation",label:"地理位置","min-width":"160","show-overflow-tooltip":""},{default:s(({row:t})=>[p("span",null,x(M(t.geoLocation)),1)]),_:1}),o(f,{prop:"sourceTaskCode",label:"来源任务",width:"240","show-overflow-tooltip":""},{default:s(({row:t})=>[t.sourceTaskCode?(c(),V(b,{key:0,type:"primary",link:"",onClick:h=>ie(t)},{default:s(()=>[m(x(t.sourceTaskCode),1)]),_:2},1032,["onClick"])):(c(),k("span",Re,"-"))]),_:1}),o(f,{prop:"createdAt",label:"入池时间",width:"170"}),o(f,{label:"操作",width:"200",fixed:"right"},{default:s(({row:t})=>[o(b,{size:"small",type:"primary",plain:"",onClick:h=>le(t)},{default:s(()=>[...e[23]||(e[23]=[m("认领",-1)])]),_:1},8,["onClick"]),o(b,{size:"small",type:"danger",plain:"",onClick:h=>se(t)},{default:s(()=>[...e[24]||(e[24]=[m("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])]),p("div",ze,[o(ge,{class:"en-pagination",layout:"total, sizes, prev, pager, next",total:D.value,"page-sizes":[20,50,100],"page-size":C.size,"current-page":C.current,"onUpdate:currentPage":e[2]||(e[2]=t=>C.current=t),onSizeChange:Z,onCurrentChange:ee},null,8,["total","page-size","current-page"])])]),o(_e,{modelValue:n.visible,"onUpdate:modelValue":e[16]||(e[16]=t=>n.visible=t),title:"资产认领",width:"820px",class:"en-claim-dialog"},{footer:s(()=>[o(b,{onClick:e[15]||(e[15]=t=>n.visible=!1)},{default:s(()=>[...e[30]||(e[30]=[m("取消",-1)])]),_:1}),o(b,{type:"primary",loading:n.loading,onClick:ae},{default:s(()=>[...e[31]||(e[31]=[m("确认认领",-1)])]),_:1},8,["loading"])]),default:s(()=>[o(ye,{type:"warning","show-icon":"",closable:!1,style:{"margin-bottom":"12px"}},{default:s(()=>[...e[25]||(e[25]=[m("认领操作只会发生一次，认领成功后资产进入资产列表。",-1)])]),_:1}),p("div",Pe,[o(Ce,{ref_key:"formRef",ref:z,model:n.form,rules:X,"label-width":"110px"},{default:s(()=>[o(P,{"content-position":"left"},{default:s(()=>[...e[26]||(e[26]=[m("发现信息（只读）",-1)])]),_:1}),p("div",qe,[o(u,{label:"发现地址"},{default:s(()=>[o(d,{modelValue:n.discoveredAddress,"onUpdate:modelValue":e[3]||(e[3]=t=>n.discoveredAddress=t),readonly:""},null,8,["modelValue"])]),_:1}),o(u,{label:"标题"},{default:s(()=>[o(d,{modelValue:n.discoveredTitle,"onUpdate:modelValue":e[4]||(e[4]=t=>n.discoveredTitle=t),readonly:""},null,8,["modelValue"])]),_:1}),o(u,{label:"IP"},{default:s(()=>[o(d,{modelValue:n.discoveredIp,"onUpdate:modelValue":e[5]||(e[5]=t=>n.discoveredIp=t),readonly:""},null,8,["modelValue"])]),_:1}),n.geoLocationRef?(c(),V(u,{key:0,label:"位置参考"},{default:s(()=>[o(d,{"model-value":M(n.geoLocationRef),readonly:""},null,8,["model-value"]),e[27]||(e[27]=p("div",{class:"en-muted",style:{"font-size":"12px","margin-top":"6px"}},"来自系统识别，仅供参考；请在“地理位置”中确认最终位置。",-1))]),_:1})):Se("",!0)]),o(P,{"content-position":"left"},{default:s(()=>[...e[28]||(e[28]=[m("资产信息",-1)])]),_:1}),o(u,{label:"资产名称",prop:"assetName",required:""},{default:s(()=>[o(d,{modelValue:n.form.assetName,"onUpdate:modelValue":e[6]||(e[6]=t=>n.form.assetName=t)},null,8,["modelValue"])]),_:1}),o(u,{label:"资产类型",prop:"assetType",required:""},{default:s(()=>[o(a,{modelValue:n.form.assetType,"onUpdate:modelValue":e[7]||(e[7]=t=>n.form.assetType=t),style:{width:"100%"}},{default:s(()=>[(c(!0),k(S,null,U(E.value,t=>(c(),V(i,{key:t.itemCode,label:t.itemName,value:t.itemCode},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),o(u,{label:"资产状态",prop:"assetStatus",required:""},{default:s(()=>[o(a,{modelValue:n.form.assetStatus,"onUpdate:modelValue":e[8]||(e[8]=t=>n.form.assetStatus=t),style:{width:"100%"}},{default:s(()=>[(c(!0),k(S,null,U(T.value,t=>(c(),V(i,{key:t.itemCode,label:t.itemName,value:t.itemCode},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),o(u,{label:"业务重要性",prop:"importance",required:""},{default:s(()=>[o(a,{modelValue:n.form.importance,"onUpdate:modelValue":e[9]||(e[9]=t=>n.form.importance=t),style:{width:"100%"}},{default:s(()=>[(c(!0),k(S,null,U(R.value,t=>(c(),V(i,{key:t.itemCode,label:t.itemName,value:t.itemCode},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),o(u,{label:"地理位置",prop:"geoLocation",required:""},{default:s(()=>[o(Ne,{modelValue:n.form.geoLocation,"onUpdate:modelValue":e[10]||(e[10]=t=>n.form.geoLocation=t),class:"en-geo-wide"},null,8,["modelValue"])]),_:1}),o(P,{"content-position":"left"},{default:s(()=>[...e[29]||(e[29]=[m("补充信息",-1)])]),_:1}),o(u,{label:"负责人"},{default:s(()=>[o(d,{modelValue:n.form.owner,"onUpdate:modelValue":e[11]||(e[11]=t=>n.form.owner=t)},null,8,["modelValue"])]),_:1}),o(u,{label:"所属部门"},{default:s(()=>[o(d,{modelValue:n.form.department,"onUpdate:modelValue":e[12]||(e[12]=t=>n.form.department=t)},null,8,["modelValue"])]),_:1}),o(u,{label:"技术栈"},{default:s(()=>[o(d,{modelValue:n.form.techStack,"onUpdate:modelValue":e[13]||(e[13]=t=>n.form.techStack=t)},null,8,["modelValue"])]),_:1}),o(u,{label:"资产描述"},{default:s(()=>[o(d,{modelValue:n.form.assetDesc,"onUpdate:modelValue":e[14]||(e[14]=t=>n.form.assetDesc=t),type:"textarea",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])])]),_:1},8,["modelValue"])],64)}}},We=we(De,[["__scopeId","data-v-5ec81623"]]);export{We as default};
