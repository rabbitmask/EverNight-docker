import{_ as he,a as A,r as R,k as J,o as X,c as w,d as g,e as a,w as o,f as m,l as Ne,F as h,h as T,n as $,g as _,m as x,p as U,j as d,t as p,u as Z,q as Ee,s as xe,v as Ue,E as b,x as ee}from"./index-s_Bt94In.js";import{g as q}from"./bizDict-5M-M5nwd.js";import{G as Pe,c as ze}from"./clipboard-Mcol6N4z.js";const Le={class:"en-page"},Ie={class:"en-toolbar"},Re={class:"en-table-wrap"},Be={class:"en-link-trigger"},$e={class:"en-drop-item"},qe={class:"en-drop-item"},De={class:"en-footer"},We={key:0},Me={key:1},Oe={key:2},Ge={class:"en-detail-block"},je={class:"en-detail-block"},Fe={key:0,class:"en-muted",style:{"margin-top":"8px"}},He={class:"en-form-panel"},Ke={__name:"Assets",setup(Qe){const P=A([]),D=A(0),c=R({assetType:"",importance:"",keyword:""}),k=R({current:1,size:20}),W=A(),V=A(new Set),u=R({visible:!1,loading:!1,asset:null,logs:[]}),N=A([]),M=J(()=>{var t,e,n;return((t=N.value.find(l=>l.itemCode==="可用"))==null?void 0:t.itemCode)||((n=(e=N.value)==null?void 0:e[0])==null?void 0:n.itemCode)||"可用"}),z=A(),te={assetName:[{required:!0,message:"资产名称不能为空",trigger:"blur"}],assetType:[{required:!0,message:"资产类型不能为空",trigger:"change"}],assetAddress:[{required:!0,message:"资产地址不能为空",trigger:"blur"}],importance:[{required:!0,message:"业务重要性不能为空",trigger:"change"}],assetStatus:[{required:!0,message:"资产状态不能为空",trigger:"change"}],geoLocation:[{required:!0,message:"地理位置不能为空",trigger:"change"}]},r=R({visible:!1,loading:!1,mode:"create",assetCode:"",form:{assetName:"",assetType:"WEB_APP",assetAddress:"",importance:"一般业务",assetStatus:M.value,owner:"",department:"",techStack:"",assetDesc:"",geoLocation:""}}),E=A([]),L=A([]),ae=J(()=>Array.from(V.value).length),S=async(t=!1)=>{var l,i;const e={page:k.current,size:k.size};c.assetType&&(e.assetType=c.assetType),c.importance&&(e.importance=c.importance),c.keyword&&(e.keyword=c.keyword);const{data:n}=await T.get("/api/assets",{params:e});P.value=((l=n==null?void 0:n.data)==null?void 0:l.rows)||[],D.value=((i=n==null?void 0:n.data)==null?void 0:i.total)||0,t&&(V.value=new Set),await $(),ne()},O=async()=>{k.current=1,await S(!0)},se=t=>{k.size=t,k.current=1,S()},oe=()=>{S()},le=t=>{const e=new Set(P.value.map(l=>l.assetCode)),n=new Set(V.value);for(const l of e)n.delete(l);for(const l of t||[])l!=null&&l.assetCode&&n.add(l.assetCode);V.value=n},ne=()=>{const t=W.value;if(t)try{t.clearSelection();for(const e of P.value)V.value.has(e.assetCode)&&t.toggleRowSelection(e,!0)}catch{}},re=()=>{const t=new URLSearchParams;c.assetType&&t.set("assetType",c.assetType),c.importance&&t.set("importance",c.importance),window.open(`/api/assets/export?${t.toString()}`,"_blank")},ie=()=>{r.mode="create",r.assetCode="",r.form={assetName:"",assetType:"WEB_APP",assetAddress:"",importance:"一般业务",assetStatus:M.value,owner:"",department:"",techStack:"",assetDesc:"",geoLocation:""},r.visible=!0,$(()=>{var t,e;return(e=(t=z.value)==null?void 0:t.clearValidate)==null?void 0:e.call(t)})},de=t=>{r.mode="edit",r.assetCode=t.assetCode,r.form={...t},r.visible=!0,$(()=>{var e,n;return(n=(e=z.value)==null?void 0:e.clearValidate)==null?void 0:n.call(e)})},ue=async t=>{var e,n;if(t!=null&&t.assetCode){u.visible=!0,u.loading=!0,u.asset=null,u.logs=[];try{const[l,i]=await Promise.all([T.get(`/api/assets/${encodeURIComponent(t.assetCode)}`),T.get(`/api/assets/${encodeURIComponent(t.assetCode)}/logs`,{params:{size:50}})]);u.asset=((e=l.data)==null?void 0:e.data)||null,u.logs=((n=i.data)==null?void 0:n.data)||[]}catch{b.error("加载失败")}finally{u.loading=!1}}},me=async()=>{var t,e,n,l;r.loading=!0;try{if(await((e=(t=z.value)==null?void 0:t.validate)==null?void 0:e.call(t)),r.mode==="create")await T.post("/api/assets",r.form);else{const i={...r.form};delete i.assetCode,delete i.id,await T.put(`/api/assets/${encodeURIComponent(r.assetCode)}`,i)}b.success("保存成功"),r.visible=!1,await S()}catch(i){(l=(n=i==null?void 0:i.response)==null?void 0:n.data)!=null&&l.message?b.error(i.response.data.message):i!=null&&i.message?b.error(i.message):b.error("保存失败")}finally{r.loading=!1}},pe=async t=>{var e,n;if(t!=null&&t.assetCode){try{await ee.confirm(`确认删除资产 ${t.assetCode}？`,"删除确认",{type:"warning"})}catch{return}try{await T.delete(`/api/assets/${encodeURIComponent(t.assetCode)}`),b.success("已删除"),V.value.delete(t.assetCode),await S()}catch(l){b.error(((n=(e=l==null?void 0:l.response)==null?void 0:e.data)==null?void 0:n.message)||"删除失败")}}},ce=async()=>{var e,n;const t=Array.from(V.value);if(t.length!==0){try{await ee.confirm(`确认删除选中的 ${t.length} 条资产？`,"删除确认",{type:"warning"})}catch{return}try{await T.post("/api/assets/batch-delete",{assetCodes:t}),b.success("已删除"),V.value=new Set,await S()}catch(l){b.error(((n=(e=l==null?void 0:l.response)==null?void 0:e.data)==null?void 0:n.message)||"删除失败")}}};X(S),X(async()=>{const t=[{itemCode:"WEB_APP",itemName:"Web 应用"},{itemCode:"API",itemName:"API 接口"},{itemCode:"DOMAIN",itemName:"域名"},{itemCode:"IP",itemName:"IP地址"},{itemCode:"DB",itemName:"数据库"},{itemCode:"OTHER",itemName:"其他"}],e=[{itemCode:"核心业务",itemName:"核心业务"},{itemCode:"重要业务",itemName:"重要业务"},{itemCode:"一般业务",itemName:"一般业务"},{itemCode:"辅助业务",itemName:"辅助业务"}],n=[{itemCode:"可用",itemName:"可用"},{itemCode:"停用",itemName:"停用"}];try{const l=await q("ASSET_TYPE");if(!(l!=null&&l.length))throw new Error("empty dict items");E.value=l}catch{E.value=t}try{const l=await q("ASSET_IMPORTANCE");if(!(l!=null&&l.length))throw new Error("empty dict items");L.value=l}catch{L.value=e}try{const l=await q("ASSET_STATUS");if(!(l!=null&&l.length))throw new Error("empty dict items");N.value=l}catch{N.value=n}});const G=t=>{const e=E.value.find(n=>n.itemCode===t);return(e==null?void 0:e.itemName)||t||"未知"},fe=t=>t==="WEB_APP"||t==="API"?"success":t==="DOMAIN"?"info":t==="IP"?"warning":t==="DB"?"danger":"",ge=t=>t==="核心业务"?"danger":t==="重要业务"?"warning":t==="一般业务"?"info":"",j=t=>{const e=String(t||"").trim();if(!e)return"";if(e.startsWith("CN/"))return e.slice(3).split("/").filter(Boolean).join(" ");if(e.startsWith("INTL/")){const n=e.split("/").filter(Boolean),l=n[1]||"",i=n[2]||"";return i?`海外 ${l} ${i}`.trim():`海外 ${l}`.trim()}return e},_e=t=>t==="CREATE"?"人工录入":t==="CLAIM"?"资产认领":t==="UPDATE"?"更新":t==="DELETE"?"删除":t||"-",ye=t=>{const e=Array.isArray(t)?t:[];for(const n of e)if((n==null?void 0:n.action)==="CLAIM")return"资产认领";for(const n of e)if((n==null?void 0:n.action)==="CREATE")return"人工录入";return"-"},F=t=>{const e=String(t||"").trim();return e.startsWith("http://")||e.startsWith("https://")},be=t=>{F(t)&&window.open(t,"_blank","noopener")},ve=async(t,e)=>{if(t==="open"){be(e);return}t==="copy"&&(await ze(e)?b.success("已复制"):b.error((window==null?void 0:window.isSecureContext)===!1?"复制失败（请使用 https 或 localhost 打开）":"复制失败"))};return(t,e)=>{const n=m("el-option"),l=m("el-select"),i=m("el-input"),C=m("el-button"),f=m("el-table-column"),B=m("el-tag"),H=m("el-icon"),K=m("el-dropdown-item"),we=m("el-dropdown-menu"),Ce=m("el-dropdown"),Q=m("el-table"),ke=m("el-pagination"),y=m("el-descriptions-item"),Ve=m("el-descriptions"),Ae=m("el-drawer"),Y=m("el-divider"),v=m("el-form-item"),Se=m("el-form"),Te=m("el-dialog");return _(),w(h,null,[g("div",Le,[g("div",Ie,[a(l,{modelValue:c.assetType,"onUpdate:modelValue":e[0]||(e[0]=s=>c.assetType=s),placeholder:"资产类型",clearable:"",style:{width:"190px"}},{default:o(()=>[(_(!0),w(h,null,x(E.value,s=>(_(),U(n,{key:s.itemCode,label:s.itemName,value:s.itemCode},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a(l,{modelValue:c.importance,"onUpdate:modelValue":e[1]||(e[1]=s=>c.importance=s),placeholder:"业务重要性",clearable:"",style:{width:"190px"}},{default:o(()=>[(_(!0),w(h,null,x(L.value,s=>(_(),U(n,{key:s.itemCode,label:s.itemName,value:s.itemCode},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a(i,{modelValue:c.keyword,"onUpdate:modelValue":e[2]||(e[2]=s=>c.keyword=s),placeholder:"名称/地址/负责人/部门",style:{width:"240px"},clearable:"",onKeyup:Ne(O,["enter"])},null,8,["modelValue"]),a(C,{onClick:O},{default:o(()=>[...e[17]||(e[17]=[d("查询",-1)])]),_:1}),a(C,{onClick:re},{default:o(()=>[...e[18]||(e[18]=[d("导出",-1)])]),_:1}),a(C,{type:"danger",plain:"",disabled:ae.value===0,onClick:ce},{default:o(()=>[...e[19]||(e[19]=[d("批量删除",-1)])]),_:1},8,["disabled"]),e[21]||(e[21]=g("div",{class:"spacer"},null,-1)),a(C,{type:"primary",onClick:ie},{default:o(()=>[...e[20]||(e[20]=[d("新增资产",-1)])]),_:1})]),g("div",Re,[a(Q,{ref_key:"assetTableRef",ref:W,data:P.value,height:"100%",border:"","row-key":"assetCode","reserve-selection":!0,onSelectionChange:le},{default:o(()=>[a(f,{type:"selection",width:"46"}),a(f,{prop:"assetCode",label:"资产编码",width:"240","show-overflow-tooltip":""}),a(f,{prop:"assetName",label:"资产名称","min-width":"170","show-overflow-tooltip":""}),a(f,{prop:"assetType",label:"类型",width:"110"},{default:o(({row:s})=>[a(B,{size:"small",type:fe(s.assetType)},{default:o(()=>[d(p(G(s.assetType)),1)]),_:2},1032,["type"])]),_:1}),a(f,{prop:"assetAddress",label:"地址","min-width":"260","show-overflow-tooltip":""},{default:o(({row:s})=>[a(Ce,{trigger:"click",onCommand:I=>ve(I,s.assetAddress)},{dropdown:o(()=>[a(we,null,{default:o(()=>[a(K,{command:"open",disabled:!F(s.assetAddress)},{default:o(()=>[g("span",$e,[a(H,null,{default:o(()=>[a(Z(Ee))]),_:1}),e[22]||(e[22]=d(" 访问 ",-1))])]),_:1},8,["disabled"]),a(K,{command:"copy"},{default:o(()=>[g("span",qe,[a(H,null,{default:o(()=>[a(Z(xe))]),_:1}),e[23]||(e[23]=d(" 复制 ",-1))])]),_:1})]),_:2},1024)]),default:o(()=>[g("span",Be,p(s.assetAddress),1)]),_:2},1032,["onCommand"])]),_:1}),a(f,{prop:"importance",label:"重要性",width:"110"},{default:o(({row:s})=>[a(B,{size:"small",effect:"plain",type:ge(s.importance)},{default:o(()=>[d(p(s.importance),1)]),_:2},1032,["type"])]),_:1}),a(f,{prop:"assetStatus",label:"状态",width:"100"},{default:o(({row:s})=>[a(B,{size:"small",effect:"plain"},{default:o(()=>[d(p(s.assetStatus),1)]),_:2},1024)]),_:1}),a(f,{prop:"owner",label:"负责人",width:"100","show-overflow-tooltip":""}),a(f,{prop:"department",label:"部门",width:"120","show-overflow-tooltip":""}),a(f,{prop:"geoLocation",label:"地理位置","min-width":"140","show-overflow-tooltip":""},{default:o(({row:s})=>[g("span",null,p(j(s.geoLocation)),1)]),_:1}),a(f,{label:"操作",width:"240",fixed:"right"},{default:o(({row:s})=>[a(C,{size:"small",onClick:I=>ue(s)},{default:o(()=>[...e[24]||(e[24]=[d("详情",-1)])]),_:1},8,["onClick"]),a(C,{size:"small",onClick:I=>de(s)},{default:o(()=>[...e[25]||(e[25]=[d("编辑",-1)])]),_:1},8,["onClick"]),a(C,{size:"small",type:"danger",plain:"",onClick:I=>pe(s)},{default:o(()=>[...e[26]||(e[26]=[d("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])]),g("div",De,[a(ke,{class:"en-pagination",layout:"total, sizes, prev, pager, next",total:D.value,"page-sizes":[20,50,100],"page-size":k.size,"current-page":k.current,"onUpdate:currentPage":e[3]||(e[3]=s=>k.current=s),onSizeChange:se,onCurrentChange:oe},null,8,["total","page-size","current-page"])])]),a(Ae,{modelValue:u.visible,"onUpdate:modelValue":e[4]||(e[4]=s=>u.visible=s),title:"资产详情",size:"55vw","min-size":580,"max-size":900},{default:o(()=>[u.loading?(_(),w("div",We,"加载中...")):u.asset?(_(),w("div",Oe,[e[27]||(e[27]=g("div",{class:"en-section-title"},"资产信息",-1)),g("div",Ge,[a(Ve,{column:1,border:"","label-width":"120px"},{default:o(()=>[a(y,{label:"资产编码"},{default:o(()=>[d(p(u.asset.assetCode),1)]),_:1}),a(y,{label:"资产名称"},{default:o(()=>[d(p(u.asset.assetName),1)]),_:1}),a(y,{label:"资产类型"},{default:o(()=>[d(p(G(u.asset.assetType)),1)]),_:1}),a(y,{label:"资产地址"},{default:o(()=>[d(p(u.asset.assetAddress),1)]),_:1}),a(y,{label:"业务重要性"},{default:o(()=>[d(p(u.asset.importance),1)]),_:1}),a(y,{label:"资产状态"},{default:o(()=>[d(p(u.asset.assetStatus),1)]),_:1}),a(y,{label:"负责人"},{default:o(()=>[d(p(u.asset.owner||"-"),1)]),_:1}),a(y,{label:"所属部门"},{default:o(()=>[d(p(u.asset.department||"-"),1)]),_:1}),a(y,{label:"地理位置"},{default:o(()=>[d(p(j(u.asset.geoLocation)||"-"),1)]),_:1}),a(y,{label:"来源方式"},{default:o(()=>[d(p(ye(u.logs)),1)]),_:1}),a(y,{label:"创建时间"},{default:o(()=>[d(p(u.asset.createdAt||"-"),1)]),_:1}),a(y,{label:"更新时间"},{default:o(()=>[d(p(u.asset.updatedAt||"-"),1)]),_:1})]),_:1})]),e[28]||(e[28]=g("div",{class:"en-section-title",style:{"margin-top":"12px"}},"相关日志",-1)),g("div",je,[a(Q,{data:u.logs,border:"",height:"320px"},{default:o(()=>[a(f,{prop:"logCode",label:"日志编号",width:"220","show-overflow-tooltip":""}),a(f,{prop:"createdAt",label:"时间",width:"170"}),a(f,{prop:"action",label:"来源方式",width:"140"},{default:o(({row:s})=>[g("span",null,p(_e(s.action)),1)]),_:1}),a(f,{prop:"operator",label:"操作者",width:"160","show-overflow-tooltip":""})]),_:1},8,["data"]),u.logs.length===0?(_(),w("div",Fe,"暂无")):Ue("",!0)])])):(_(),w("div",Me,"暂无"))]),_:1},8,["modelValue"]),a(Te,{modelValue:r.visible,"onUpdate:modelValue":e[16]||(e[16]=s=>r.visible=s),title:r.mode==="create"?"新增资产":"编辑资产",width:"820px",class:"en-asset-dialog"},{footer:o(()=>[a(C,{onClick:e[15]||(e[15]=s=>r.visible=!1)},{default:o(()=>[...e[31]||(e[31]=[d("取消",-1)])]),_:1}),a(C,{type:"primary",loading:r.loading,onClick:me},{default:o(()=>[...e[32]||(e[32]=[d("保存",-1)])]),_:1},8,["loading"])]),default:o(()=>[g("div",He,[a(Se,{ref_key:"formRef",ref:z,model:r.form,rules:te,"label-width":"110px"},{default:o(()=>[a(Y,{"content-position":"left"},{default:o(()=>[...e[29]||(e[29]=[d("基础信息",-1)])]),_:1}),a(v,{label:"资产名称",prop:"assetName",required:""},{default:o(()=>[a(i,{modelValue:r.form.assetName,"onUpdate:modelValue":e[5]||(e[5]=s=>r.form.assetName=s)},null,8,["modelValue"])]),_:1}),a(v,{label:"资产类型",prop:"assetType",required:""},{default:o(()=>[a(l,{modelValue:r.form.assetType,"onUpdate:modelValue":e[6]||(e[6]=s=>r.form.assetType=s),style:{width:"100%"}},{default:o(()=>[(_(!0),w(h,null,x(E.value,s=>(_(),U(n,{key:s.itemCode,label:s.itemName,value:s.itemCode},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(v,{label:"资产状态",prop:"assetStatus",required:""},{default:o(()=>[a(l,{modelValue:r.form.assetStatus,"onUpdate:modelValue":e[7]||(e[7]=s=>r.form.assetStatus=s),style:{width:"100%"}},{default:o(()=>[(_(!0),w(h,null,x(N.value,s=>(_(),U(n,{key:s.itemCode,label:s.itemName,value:s.itemCode},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(v,{label:"资产地址",prop:"assetAddress",required:""},{default:o(()=>[a(i,{modelValue:r.form.assetAddress,"onUpdate:modelValue":e[8]||(e[8]=s=>r.form.assetAddress=s),placeholder:"如 https://a.com 或 1.1.1.1:22"},null,8,["modelValue"])]),_:1}),a(v,{label:"业务重要性",prop:"importance",required:""},{default:o(()=>[a(l,{modelValue:r.form.importance,"onUpdate:modelValue":e[9]||(e[9]=s=>r.form.importance=s),style:{width:"100%"}},{default:o(()=>[(_(!0),w(h,null,x(L.value,s=>(_(),U(n,{key:s.itemCode,label:s.itemName,value:s.itemCode},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(v,{label:"地理位置",prop:"geoLocation",required:""},{default:o(()=>[a(Pe,{modelValue:r.form.geoLocation,"onUpdate:modelValue":e[10]||(e[10]=s=>r.form.geoLocation=s)},null,8,["modelValue"])]),_:1}),a(Y,{"content-position":"left"},{default:o(()=>[...e[30]||(e[30]=[d("补充信息",-1)])]),_:1}),a(v,{label:"负责人"},{default:o(()=>[a(i,{modelValue:r.form.owner,"onUpdate:modelValue":e[11]||(e[11]=s=>r.form.owner=s)},null,8,["modelValue"])]),_:1}),a(v,{label:"所属部门"},{default:o(()=>[a(i,{modelValue:r.form.department,"onUpdate:modelValue":e[12]||(e[12]=s=>r.form.department=s)},null,8,["modelValue"])]),_:1}),a(v,{label:"技术栈"},{default:o(()=>[a(i,{modelValue:r.form.techStack,"onUpdate:modelValue":e[13]||(e[13]=s=>r.form.techStack=s)},null,8,["modelValue"])]),_:1}),a(v,{label:"资产描述"},{default:o(()=>[a(i,{modelValue:r.form.assetDesc,"onUpdate:modelValue":e[14]||(e[14]=s=>r.form.assetDesc=s),type:"textarea",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])])]),_:1},8,["modelValue","title"])],64)}}},Ze=he(Ke,[["__scopeId","data-v-204af337"]]);export{Ze as default};
